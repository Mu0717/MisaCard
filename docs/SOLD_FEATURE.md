# 售卖状态功能说明

## 📋 功能概述

本次更新为卡片管理系统新增了"售卖状态"功能，允许用户标记和跟踪卡片的售卖情况。

## ✨ 新增功能

### 1. 前端功能

#### 卡片列表页面
- **售卖状态筛选器**：可以筛选"全部/已售卖/未售卖"
- **售卖状态列**：表格中新增"售卖"列，显示卡片的售卖状态徽章
- **操作按钮**：每张卡片行添加"标记售卖"/"取消售卖"按钮

#### 批量操作
- **批量标记售卖**：选中多张卡片后，可以批量标记为已售卖
- **一键选中已激活未售卖**：快速选择所有已激活但未售卖的卡片

#### 卡片详情
- **售卖状态显示**：详情页面显示完整的售卖状态信息
- **售卖时间**：如果已售卖，显示具体的售卖时间
- **快速切换**：详情页面可以直接切换售卖状态

#### 统计数据
- **概览统计**：概览页面新增"已售卖"统计卡片
- **实时更新**：统计数据实时反映当前售卖情况

### 2. 后端功能

#### API 端点
新增 API 端点：`POST /api/cards/{card_id}/mark-sold`

**功能**：切换卡片的售卖状态（标记/取消标记已售卖）

**请求头**：
```
Authorization: Bearer <access_token>
```

**响应示例**：
```json
{
  "success": true,
  "message": "已标记为已售卖",
  "data": {
    "is_sold": true
  }
}
```

#### 数据库字段
在 `cards` 表中新增两个字段：
- `is_sold` (BOOLEAN)：是否已售卖，默认 False
- `sold_time` (TIMESTAMP)：售卖时间，默认 NULL

## 🚀 使用方法

### 单个卡片标记售卖
1. 进入"卡片列表"页面
2. 找到要标记的卡片
3. 点击该卡片的"标记售卖"按钮
4. 状态立即更新为"已售卖"

### 批量标记售卖
1. 进入"卡片列表"页面
2. 使用复选框选中多张卡片
   - 可以手动勾选
   - 或点击"一键选中已激活未售卖"按钮快速选择
3. 点击"批量标记售卖"按钮
4. 确认后批量更新状态

### 筛选已售卖/未售卖卡片
1. 进入"卡片列表"页面
2. 使用"售卖状态"下拉筛选器
3. 选择"已售卖"或"未售卖"
4. 点击"搜索"按钮查看筛选结果

### 查看售卖详情
1. 点击卡片的"详情"按钮
2. 在详情页面查看：
   - 售卖状态（已售卖/未售卖）
   - 售卖时间（如果已售卖）
3. 可以直接在详情页面切换售卖状态

## 🔧 技术实现

### 数据库迁移
已执行迁移脚本：`migrate_add_sold_field.py`
- 为现有数据库添加 `is_sold` 和 `sold_time` 字段
- 默认所有现有卡片为"未售卖"状态

### 文件修改清单
1. **前端** (`app/templates/index.html`)
   - 新增售卖状态筛选器
   - 表格新增售卖状态列
   - 新增单个/批量标记售卖功能
   - 新增一键选中已激活未售卖功能
   - 详情页面显示售卖信息
   - 概览页面显示售卖统计

2. **后端模型** (`app/models.py`)
   - Card 模型新增 `is_sold` 字段
   - Card 模型新增 `sold_time` 字段

3. **后端API** (`app/api/cards.py`)
   - 新增 `toggle_sold_status` 接口

4. **数据模型** (`app/schemas.py`)
   - CardResponse 模型新增 `is_sold` 和 `sold_time` 字段

5. **数据库迁移** (`migrate_add_sold_field.py`)
   - 自动迁移脚本，添加新字段

## 📝 注意事项

1. **权限要求**：标记售卖功能需要登录后才能使用
2. **状态切换**：可以随时切换售卖状态（标记/取消标记）
3. **时间记录**：
   - 标记为已售卖时自动记录售卖时间
   - 取消售卖标记时清除售卖时间
4. **数据安全**：所有操作都会记录在数据库中

## 🎯 应用场景

1. **卡片销售管理**：跟踪哪些卡片已经售出
2. **库存管理**：快速筛选未售卖的库存卡片
3. **销售统计**：统计已售卖的卡片数量
4. **批量操作**：快速标记多张已售出的卡片

## ⚡ 性能优化

- 批量操作支持同时标记多张卡片
- 筛选功能在数据库层面执行，性能优秀
- 前端实时更新，无需刷新页面

## 🆘 故障排查

### 接口返回 404
- 确保已运行数据库迁移脚本：`python migrate_add_sold_field.py`
- 确保服务器已重启并加载最新代码

### 售卖状态不显示
- 检查前端是否已刷新
- 清除浏览器缓存后重试

### 批量操作失败
- 检查是否已登录
- 确认选中的卡片数量
- 查看浏览器控制台的错误信息

## 📊 数据库查询示例

```sql
-- 查询所有已售卖的卡片
SELECT * FROM cards WHERE is_sold = 1;

-- 查询未售卖的已激活卡片
SELECT * FROM cards 
WHERE is_sold = 0 
  AND is_activated = 1 
  AND status != 'deleted';

-- 统计售卖情况
SELECT 
  COUNT(*) as total,
  SUM(CASE WHEN is_sold = 1 THEN 1 ELSE 0 END) as sold_count,
  SUM(CASE WHEN is_sold = 0 THEN 1 ELSE 0 END) as unsold_count
FROM cards 
WHERE status != 'deleted';
```

## 🔄 版本历史

- **v2.1.0** (2024-12-10)
  - 新增售卖状态功能
  - 支持单个和批量标记售卖
  - 新增售卖状态筛选和统计

---

**开发者**：AI Assistant  
**更新时间**：2024-12-10  
**版本**：v2.1.0

