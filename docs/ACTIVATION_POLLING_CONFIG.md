# 激活轮询配置说明

## 📌 功能介绍

当激活卡片时，如果API返回的 `result` 为 `null`，系统会自动进行轮询重试，直到激活成功或达到最大重试次数。

## ⚙️ 配置参数

### 环境变量配置

在 `.env` 文件中可以配置以下参数：

```env
# 激活轮询配置
ACTIVATION_MAX_RETRIES=20    # 最大重试次数（默认20次）
ACTIVATION_RETRY_DELAY=3     # 重试间隔秒数（默认3秒）
```

### 默认配置

如果不设置环境变量，系统使用以下默认值：
- **最大重试次数**: 20次
- **重试间隔**: 3秒

这意味着系统最多会尝试激活 21次（初次 + 20次重试），总耗时最长约 60秒。

## 🔄 工作流程

```
1. 发送激活请求
   ↓
2. 检查响应
   ├─ result 存在且 status="已激活" → ✅ 成功
   ├─ result 为 null → ⏳ 等待 3 秒后重试
   ├─ 永久性错误（已删除/不存在/已过期） → ❌ 停止重试
   └─ 其他错误 → ⏳ 等待 3 秒后重试
   ↓
3. 重复步骤1-2，直到成功或达到最大重试次数
```

## 📋 重试场景

### 会触发重试的情况：
- ✅ `result` 为 `null`（API正在处理中）
- ✅ `status` 不是 "已激活"
- ✅ HTTP 状态码异常
- ✅ 请求超时
- ✅ 网络错误

### 不会重试的情况（永久性错误）：
- ❌ 错误消息包含 "已删除"
- ❌ 错误消息包含 "不存在"
- ❌ 错误消息包含 "已过期"

## 🎯 使用示例

### 使用默认配置
```python
from app.utils.activation import activate_card_via_api

# 使用配置文件中的默认值（20次重试，每次间隔3秒）
success, card_data, error = await activate_card_via_api("mio-xxx-xxx")
```

### 自定义重试配置
```python
# 自定义：最多重试10次，每次间隔5秒
success, card_data, error = await activate_card_via_api(
    "mio-xxx-xxx", 
    max_retries=10, 
    retry_delay=5
)
```

### 修改全局配置
在 `.env` 文件中添加：
```env
# 更激进的重试策略：最多重试50次，每次间隔2秒
ACTIVATION_MAX_RETRIES=50
ACTIVATION_RETRY_DELAY=2

# 或者更保守的策略：最多重试5次，每次间隔10秒
ACTIVATION_MAX_RETRIES=5
ACTIVATION_RETRY_DELAY=10
```

## 📊 日志输出示例

```
============================================================
[激活卡片 (第 1/21 次尝试)] 请求URL: https://api.misacard.com/api/card/activate/mio-xxx
[激活卡片] 请求方法: POST
[激活卡片] 响应状态码: 200
[激活卡片] 响应内容: {"result":null,"msg":null,"error":null}
[激活卡片] ⚠️  result为空（可能正在处理中）
[激活卡片] 将在 3 秒后重试...
============================================================

============================================================
[激活卡片 (第 2/21 次尝试)] 请求URL: https://api.misacard.com/api/card/activate/mio-xxx
[激活卡片] 请求方法: POST
[激活卡片] 响应状态码: 200
[激活卡片] 响应内容: {"result":{"status":"已激活",...},"msg":null,"error":null}
[激活卡片] 卡片状态: 已激活
[激活卡片] ✓ 激活成功!
============================================================
```

## ⚠️ 注意事项

1. **合理设置重试次数**：过多的重试会增加API压力和等待时间
2. **注意总耗时**：`总耗时 ≈ 重试次数 × 重试间隔`
3. **永久性错误会立即停止**：如果卡片已删除或不存在，不会浪费时间重试
4. **批量激活时**：每张卡片都会独立进行轮询重试

## 🔧 性能优化建议

根据您的使用场景选择合适的配置：

| 场景 | 推荐配置 | 说明 |
|------|---------|------|
| 快速激活 | MAX_RETRIES=5, DELAY=2 | 最快约10秒完成 |
| 标准激活 | MAX_RETRIES=20, DELAY=3 | 最长约60秒（默认） |
| 耐心等待 | MAX_RETRIES=50, DELAY=5 | 最长约4分钟 |
| API限流 | MAX_RETRIES=10, DELAY=10 | 避免请求过于频繁 |

## 📞 技术支持

如有问题，请检查：
1. 日志输出中的详细错误信息
2. API 返回的 `error` 字段
3. 网络连接状态
4. API Token 是否有效

