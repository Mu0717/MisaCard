# å®‰å…¨éƒ¨ç½²æŒ‡å—

## âš ï¸ é‡è¦æé†’

æœ¬æ¬¡æ›´æ–°**ä¿®æ”¹äº†æ•°æ®åº“ç»“æ„**ï¼Œæ·»åŠ äº†æ–°å­—æ®µï¼š
- `is_sold` (BOOLEAN) - æ˜¯å¦å·²å”®å–
- `sold_time` (TIMESTAMP) - å”®å–æ—¶é—´

**ç›´æ¥é‡å¯ä¼šå¯¼è‡´é¡¹ç›®å¯åŠ¨å¤±è´¥ï¼** å¿…é¡»å…ˆè¿è¡Œæ•°æ®åº“è¿ç§»ã€‚

## ğŸ” å®‰å…¨éƒ¨ç½²æ­¥éª¤

### æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨è‡ªåŠ¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

æˆ‘ä»¬æä¾›äº†è‡ªåŠ¨å¤„ç†è¿ç§»çš„éƒ¨ç½²è„šæœ¬ï¼š

```bash
# 1. ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x safe_deploy.sh

# 2. è¿è¡Œå®‰å…¨éƒ¨ç½²è„šæœ¬
./safe_deploy.sh
```

#### è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. âœ… **å¤‡ä»½æ•°æ®åº“** - åˆ›å»ºæ—¶é—´æˆ³å¤‡ä»½
2. âœ… **æ‹‰å–ä»£ç ** - æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
3. âœ… **è¿è¡Œè¿ç§»** - è‡ªåŠ¨æ·»åŠ æ–°å­—æ®µ
4. âœ… **æ„å»ºé•œåƒ** - é‡æ–°æ„å»ºDockeré•œåƒ
5. âœ… **é‡å¯å®¹å™¨** - å®‰å…¨é‡å¯åº”ç”¨
6. âœ… **éªŒè¯å¯åŠ¨** - æ£€æŸ¥æ˜¯å¦æ­£å¸¸è¿è¡Œ

### æ–¹æ¡ˆäºŒï¼šæ‰‹åŠ¨éƒ¨ç½²ï¼ˆæ¨èç†è§£æµç¨‹ï¼‰

#### æ­¥éª¤1ï¼šå¤‡ä»½æ•°æ®åº“

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p backups

# å¤‡ä»½æ•°æ®åº“
cp data/cards.db backups/cards_backup_$(date +%Y%m%d_%H%M%S).db

# éªŒè¯å¤‡ä»½
ls -lh backups/
```

#### æ­¥éª¤2ï¼šæ‹‰å–æœ€æ–°ä»£ç 

```bash
git pull
```

#### æ­¥éª¤3ï¼šè¿è¡Œæ•°æ®åº“è¿ç§»

**é€‰é¡¹Aï¼šåœ¨å®¿ä¸»æœºè¿è¡Œ**ï¼ˆå¦‚æœæœ‰Pythonç¯å¢ƒï¼‰
```bash
python3 migrate_add_sold_field.py
```

**é€‰é¡¹Bï¼šåœ¨å®¹å™¨å†…è¿è¡Œ**
```bash
# å¦‚æœå®¹å™¨æ­£åœ¨è¿è¡Œ
docker exec misacard-manager python3 migrate_add_sold_field.py
```

#### æ­¥éª¤4ï¼šé‡æ–°æ„å»ºå¹¶å¯åŠ¨

```bash
# æ„å»ºæ–°é•œåƒ
docker build -t misacard-manager:latest .

# åœæ­¢æ—§å®¹å™¨
docker rm -f misacard-manager

# å¯åŠ¨æ–°å®¹å™¨ï¼ˆå†…ç½®è‡ªåŠ¨è¿ç§»æ£€æŸ¥ï¼‰
docker run -d \
  --name misacard-manager \
  -p 8000:8000 \
  -v $(pwd)/data:/app/data \
  -e DATABASE_URL=sqlite:///./data/cards.db \
  -e TZ=Asia/Shanghai \
  --restart unless-stopped \
  misacard-manager:latest
```

#### æ­¥éª¤5ï¼šéªŒè¯å¯åŠ¨

```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker ps | grep misacard-manager

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker logs misacard-manager

# æ£€æŸ¥è¿ç§»æ˜¯å¦æˆåŠŸ
docker logs misacard-manager | grep "æ•°æ®åº“è¿ç§»"
```

## ğŸ›¡ï¸ è‡ªåŠ¨è¿ç§»ä¿æŠ¤

ä»æœ¬æ¬¡æ›´æ–°å¼€å§‹ï¼ŒDockeré•œåƒå†…ç½®äº†**è‡ªåŠ¨è¿ç§»æ£€æŸ¥**ï¼š

### å·¥ä½œåŸç†

1. å®¹å™¨å¯åŠ¨æ—¶ï¼Œ`docker-entrypoint.sh` è‡ªåŠ¨æ‰§è¡Œ
2. æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨ `is_sold` å­—æ®µ
3. å¦‚æœç¼ºå°‘ï¼Œè‡ªåŠ¨è¿è¡Œ `migrate_add_sold_field.py`
4. è¿ç§»å®Œæˆåï¼Œå¯åŠ¨åº”ç”¨æœåŠ¡

### å¯åŠ¨æ—¥å¿—ç¤ºä¾‹

**é¦–æ¬¡éƒ¨ç½²ï¼ˆéœ€è¦è¿ç§»ï¼‰ï¼š**
```
==========================================
MisaCard Manager - å®¹å™¨å¯åŠ¨
==========================================
âœ“ å‘ç°ç°æœ‰æ•°æ®åº“: /app/data/cards.db

==> æ£€æŸ¥å¹¶æ‰§è¡Œæ•°æ®åº“è¿ç§»...
! æ£€æµ‹åˆ°éœ€è¦è¿ç§»: æ·»åŠ å”®å–çŠ¶æ€å­—æ®µ
==> è¿è¡Œè¿ç§»è„šæœ¬...
============================================================
æ•°æ®åº“è¿ç§»å·¥å…·ï¼šæ·»åŠ å”®å–çŠ¶æ€å­—æ®µ
============================================================
å¼€å§‹è¿ç§»æ•°æ®åº“: /app/data/cards.db
éœ€è¦æ·»åŠ å­—æ®µ: is_sold, sold_time
æ­£åœ¨æ·»åŠ  is_sold å­—æ®µ...
âœ“ is_sold å­—æ®µæ·»åŠ æˆåŠŸ
æ­£åœ¨æ·»åŠ  sold_time å­—æ®µ...
âœ“ sold_time å­—æ®µæ·»åŠ æˆåŠŸ

âœ… æ•°æ®åº“è¿ç§»å®Œæˆï¼
âœ“ è¿ç§»å®Œæˆ

==========================================
å¯åŠ¨åº”ç”¨æœåŠ¡...
==========================================
```

**å·²è¿ç§»ï¼ˆè·³è¿‡ï¼‰ï¼š**
```
==========================================
MisaCard Manager - å®¹å™¨å¯åŠ¨
==========================================
âœ“ å‘ç°ç°æœ‰æ•°æ®åº“: /app/data/cards.db

==> æ£€æŸ¥å¹¶æ‰§è¡Œæ•°æ®åº“è¿ç§»...
âœ“ æ•°æ®åº“ç»“æ„å·²æ˜¯æœ€æ–°ç‰ˆæœ¬

==========================================
å¯åŠ¨åº”ç”¨æœåŠ¡...
==========================================
```

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰è¯·ç¡®è®¤ï¼š

- [ ] å·²å¤‡ä»½æ•°æ®åº“æ–‡ä»¶ï¼ˆ`data/cards.db`ï¼‰
- [ ] å·²æ‹‰å–æœ€æ–°ä»£ç ï¼ˆ`git pull`ï¼‰
- [ ] å·²æŸ¥çœ‹æ›´æ–°æ—¥å¿—ï¼ˆ`docs/UPDATE_NOTES.md`ï¼‰
- [ ] å¦‚æœæ‰‹åŠ¨è¿ç§»ï¼Œå·²æˆåŠŸè¿è¡Œè¿ç§»è„šæœ¬
- [ ] æ•°æ®åº“æ–‡ä»¶æ‰€åœ¨ç›®å½•æœ‰å†™æƒé™

éƒ¨ç½²åè¯·éªŒè¯ï¼š

- [ ] å®¹å™¨æˆåŠŸå¯åŠ¨ï¼ˆ`docker ps`ï¼‰
- [ ] æŸ¥çœ‹å¯åŠ¨æ—¥å¿—æ— é”™è¯¯ï¼ˆ`docker logs misacard-manager`ï¼‰
- [ ] è®¿é—®ç½‘é¡µèƒ½æ­£å¸¸æ‰“å¼€ï¼ˆhttp://your-server:8000ï¼‰
- [ ] å¡ç‰‡åˆ—è¡¨èƒ½æ­£å¸¸æ˜¾ç¤º
- [ ] æ–°åŠŸèƒ½å¯ä»¥ä½¿ç”¨ï¼ˆå”®å–çŠ¶æ€æ ‡è®°ï¼‰

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜1ï¼šè¿ç§»è„šæœ¬æ‰¾ä¸åˆ°

**ç—‡çŠ¶ï¼š**
```
âš  è­¦å‘Š: æ‰¾ä¸åˆ°è¿ç§»è„šæœ¬ï¼Œä½†æ•°æ®åº“ç¼ºå°‘å­—æ®µ
```

**åŸå› ï¼š** è¿ç§»è„šæœ¬æ²¡æœ‰è¢«å¤åˆ¶åˆ°Dockeré•œåƒ

**è§£å†³ï¼š**
```bash
# ç¡®ä¿è¿ç§»è„šæœ¬åœ¨é¡¹ç›®æ ¹ç›®å½•
ls -l migrate_add_sold_field.py

# é‡æ–°æ„å»ºé•œåƒ
docker build -t misacard-manager:latest .
```

### é—®é¢˜2ï¼šæƒé™é”™è¯¯

**ç—‡çŠ¶ï¼š**
```
PermissionError: [Errno 13] Permission denied: 'data/cards.db'
```

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥æ•°æ®ç›®å½•æƒé™
ls -ld data/

# ä¿®æ”¹æƒé™ï¼ˆå¦‚æœéœ€è¦ï¼‰
chmod 755 data/
chmod 644 data/cards.db
```

### é—®é¢˜3ï¼šæ•°æ®åº“é”å®š

**ç—‡çŠ¶ï¼š**
```
sqlite3.OperationalError: database is locked
```

**åŸå› ï¼š** å¦ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨ä½¿ç”¨æ•°æ®åº“

**è§£å†³ï¼š**
```bash
# åœæ­¢æ‰€æœ‰ä½¿ç”¨æ•°æ®åº“çš„å®¹å™¨
docker stop misacard-manager

# ç­‰å¾…å‡ ç§’
sleep 3

# å†æ¬¡è¿è¡Œè¿ç§»
python3 migrate_add_sold_field.py
```

### é—®é¢˜4ï¼šå®¹å™¨å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶ï¼š** å®¹å™¨ä¸€å¯åŠ¨å°±é€€å‡º

**æ’æŸ¥æ­¥éª¤ï¼š**
```bash
# 1. æŸ¥çœ‹å®Œæ•´æ—¥å¿—
docker logs misacard-manager

# 2. å°è¯•è¿›å…¥å®¹å™¨è°ƒè¯•
docker run -it --rm \
  -v $(pwd)/data:/app/data \
  misacard-manager:latest bash

# 3. æ‰‹åŠ¨è¿è¡Œè¿ç§»
python3 migrate_add_sold_field.py

# 4. æ‰‹åŠ¨å¯åŠ¨åº”ç”¨
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœéƒ¨ç½²åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

### å¿«é€Ÿå›æ»š

```bash
# 1. åœæ­¢æ–°å®¹å™¨
docker stop misacard-manager
docker rm misacard-manager

# 2. æ¢å¤æ•°æ®åº“å¤‡ä»½
cp backups/cards_backup_YYYYMMDD_HHMMSS.db data/cards.db

# 3. å¯åŠ¨æ—§ç‰ˆæœ¬å®¹å™¨
docker run -d \
  --name misacard-manager \
  -p 8000:8000 \
  -v $(pwd)/data:/app/data \
  misacard-manager:old

# 4. éªŒè¯æœåŠ¡
curl http://localhost:8000/docs
```

### Gitå›æ»š

```bash
# æŸ¥çœ‹æäº¤å†å²
git log --oneline

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
git reset --hard <commit-hash>

# é‡æ–°æ„å»ºå’Œéƒ¨ç½²
docker build -t misacard-manager:latest .
docker restart misacard-manager
```

## ğŸ“ éƒ¨ç½²æ—¥å¿—

å»ºè®®è®°å½•æ¯æ¬¡éƒ¨ç½²ï¼š

```bash
# åˆ›å»ºéƒ¨ç½²æ—¥å¿—æ–‡ä»¶
cat >> deploy.log <<EOF
==========================================
éƒ¨ç½²æ—¶é—´: $(date)
éƒ¨ç½²ç‰ˆæœ¬: v2.1.0 (å”®å–çŠ¶æ€åŠŸèƒ½)
æ“ä½œäºº: $(whoami)
å¤‡ä»½æ–‡ä»¶: backups/cards_backup_$(date +%Y%m%d_%H%M%S).db
éƒ¨ç½²ç»“æœ: æˆåŠŸ/å¤±è´¥
å¤‡æ³¨: 
==========================================

EOF
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æ›´æ–°è¯´æ˜](./UPDATE_NOTES.md) - è¯¦ç»†çš„æ›´æ–°å†…å®¹
- [å”®å–åŠŸèƒ½è¯´æ˜](./SOLD_FEATURE.md) - æ–°åŠŸèƒ½ä½¿ç”¨æŒ‡å—
- [åˆ†é¡µåŠŸèƒ½è¯´æ˜](./PAGINATION_FEATURE.md) - åˆ†é¡µåŠŸèƒ½ä»‹ç»
- [Dockeréƒ¨ç½²](./docker-deploy.md) - Dockeréƒ¨ç½²è¯¦ç»†è¯´æ˜

## ğŸ“ æŠ€æœ¯æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼Ÿ

1. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼š`docker logs misacard-manager`
2. æ£€æŸ¥æ•°æ®åº“ï¼š`python3 verify_migration.py`
3. æŸ¥é˜…æ–‡æ¡£ï¼š`docs/` ç›®å½•
4. æ¢å¤å¤‡ä»½ï¼šå‚è€ƒ"å›æ»šæ–¹æ¡ˆ"

---

**æœ€åæ›´æ–°**ï¼š2024-12-10  
**ç‰ˆæœ¬**ï¼šv2.1.0

