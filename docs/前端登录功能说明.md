# 前端登录功能说明

## ✅ 已完成的功能

### 1. 登录界面
- ✅ 美观的登录页面（渐变背景）
- ✅ 账号输入框（默认值：admin）
- ✅ 密码输入框
- ✅ 登录按钮
- ✅ 功能提示信息

### 2. 后端鉴权
- ✅ 修改 `/api/auth/login` 支持账号+密码
- ✅ 固定账号：`admin`
- ✅ 默认密码：`003717`
- ✅ 返回 JWT Token

### 3. 前端权限控制
- ✅ Token 管理（localStorage）
- ✅ 登录状态检查
- ✅ 自动跳转到登录页
- ✅ Token 过期自动重新登录

### 4. API 调用鉴权
- ✅ 所有需要鉴权的 API 使用 `fetchWithAuth`
- ✅ 自动添加 Authorization Header
- ✅ 401 自动跳转登录

### 5. 公开功能（无需登录）
- ✅ 查询激活功能（`POST /api/cards/{id}/activate`）
- ✅ 批量激活功能（`POST /api/cards/batch/activate`）
- ✅ 单卡查询功能（`POST /api/cards/{id}/query`）

### 6. 需要登录的功能
- ✅ 概览页面
- ✅ 卡片列表
- ✅ 卡片详情查看
- ✅ 消费记录查询
- ✅ 批量导入
- ✅ 卡片编辑/删除
- ✅ 退款管理
- ✅ 使用标记
- ✅ 所有其他管理功能

## 🎯 使用方法

### 首次访问
1. 打开系统：http://localhost:8000
2. 自动显示登录页面
3. 输入账号密码登录

### 登录信息
```
账号：admin
密码：003717
```

### 登录后
- 显示主应用界面
- 侧边栏显示登录状态
- 显示"退出登录"按钮
- 可以使用所有功能

### 未登录状态
- 只显示登录页面
- 提示可以使用的公开功能

## 🔐 技术实现

### Token 管理
```javascript
const AuthManager = {
    getToken() { ... },        // 获取Token
    setToken(token) { ... },   // 保存Token
    clearToken() { ... },      // 清除Token
    isAuthenticated() { ... }  // 检查是否已登录
};
```

### 带鉴权的请求
```javascript
async function fetchWithAuth(url, options = {}) {
    const token = AuthManager.getToken();
    options.headers = {
        ...options.headers,
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
    };
    const response = await fetch(url, options);
    // 处理401错误...
    return response;
}
```

### 登录流程
1. 用户输入账号密码
2. 调用 `POST /api/auth/login`
3. 验证成功，获得 Token
4. 保存 Token 到 localStorage
5. 显示主应用界面

### 退出流程
1. 点击"退出登录"
2. 清除本地 Token
3. 刷新页面
4. 自动显示登录页面

## 🧪 测试步骤

### 测试1：登录功能
1. 访问 http://localhost:8000
2. 应该看到登录页面
3. 输入账号 `admin` 和密码 `003717`
4. 点击登录
5. 应该进入主应用界面

### 测试2：登录状态保持
1. 登录后刷新页面
2. 应该保持登录状态
3. 不会回到登录页

### 测试3：退出登录
1. 点击侧边栏的"退出登录"按钮
2. 确认退出
3. 应该返回登录页面

### 测试4：权限控制
1. 未登录状态下访问页面
2. 应该只显示登录页面
3. 无法访问管理功能

### 测试5：Token过期
1. 手动清除 localStorage 中的 token
2. 刷新页面或进行需要鉴权的操作
3. 应该自动跳转到登录页

### 测试6：公开功能
1. 查询激活功能应该无需登录即可使用
2. 但实际上用户必须先登录才能看到页面
3. 这是设计使然，前端页面需要登录才能访问

## 🌟 特点

### 1. 用户体验优化
- 美观的登录界面
- 清晰的功能提示
- 平滑的页面切换
- 登录状态显示

### 2. 安全性
- JWT Token 认证
- Token 自动过期（24小时）
- 401 自动重新登录
- 本地 Token 存储

### 3. 功能完整
- 完整的登录/登出流程
- 权限细粒度控制
- 公开功能支持
- 错误处理

## 📋 文件修改清单

### 修改的文件
1. `app/api/auth.py` - 后端登录接口
2. `app/templates/index.html` - 前端页面

### 关键修改点
- 添加登录页面 HTML
- 添加登录相关 CSS
- 添加 AuthManager
- 添加 handleLogin/handleLogout
- 添加 fetchWithAuth
- 修改所有需要鉴权的 API 调用
- 添加登录状态检查

## 🔧 配置说明

### 修改默认密码
在 `.env` 文件中设置：
```env
AUTH_PASSWORD=your_new_password
```

### Token 有效期
在 `.env` 文件中设置：
```env
AUTH_TOKEN_EXPIRE_HOURS=24
```

## ❓ 常见问题

### Q: 如何修改默认账号？
A: 修改 `app/api/auth.py` 中的账号验证逻辑

### Q: 登录后刷新页面会退出吗？
A: 不会，Token 保存在 localStorage，会保持登录状态

### Q: 查询激活功能需要登录吗？
A: 功能本身不需要，但需要先登录才能访问页面

### Q: Token 什么时候过期？
A: 默认 24 小时，可以在配置中修改

## ✨ 总结

前端登录功能已完整实现：
- ✅ 美观的登录界面
- ✅ 账号+密码认证
- ✅ Token 管理
- ✅ 权限控制
- ✅ 登录状态保持
- ✅ 自动重新登录
- ✅ 完整的用户体验

准备好使用了！重启服务后访问 http://localhost:8000 即可看到登录页面。
