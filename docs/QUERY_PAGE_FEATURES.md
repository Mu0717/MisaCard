# 查询激活页面新功能说明

## 📋 功能概述

为查询激活页面新增了两个重要功能：
1. **批量激活功能** - 支持一次性激活多张卡片
2. **查询使用记录功能** - 查看卡片的消费记录和交易明细

---

## 🚀 功能1：批量激活

### 功能特点
- ✅ 支持同时激活多张卡片
- ✅ 每行输入一个卡密
- ✅ 自动并发处理，速度快
- ✅ 失败卡片会自动重试
- ✅ 实时显示激活进度和结果
- ✅ 区分成功和失败的卡片

### 使用方法

1. **进入查询激活页面**
   - 无需登录即可访问（访客模式）
   - 或在登录后从侧边栏选择"查询激活"

2. **切换到批量模式**
   - 点击页面顶部的"批量激活"按钮

3. **输入卡密**
   - 在文本框中输入卡密，每行一个
   - 支持直接粘贴多行卡密
   - 示例格式：
     ```
     mio-xxxxx-xxxxx-xxxxx
     mio-yyyyy-yyyyy-yyyyy
     mio-zzzzz-zzzzz-zzzzz
     ```

4. **开始批量激活**
   - 点击"批量激活"按钮
   - 确认激活参数（并发数：5，最大重试：3次）
   - 等待激活完成

5. **查看结果**
   - 实时显示激活进度
   - 查看成功和失败的卡片列表
   - 失败的卡片会显示详细错误信息

### 技术参数
- **并发数**：5（同时处理5张卡片）
- **最大重试次数**：3次
- **适用场景**：批量开卡、快速激活

### API 接口
```
POST /api/cards/batch/activate

请求体：
{
  "card_ids": ["卡密1", "卡密2", "卡密3"],
  "concurrency": 5,
  "max_retries": 3
}
```

---

## 📊 功能2：查询使用记录

### 功能特点
- ✅ 查看卡片消费记录
- ✅ 显示卡片余额和已用金额
- ✅ 展示交易明细（商户、金额、时间）
- ✅ 支持已激活的卡片

### 使用方法

1. **查询并激活卡片**
   - 在"单张激活"模式下输入卡密
   - 点击"查询并自动激活"

2. **查看使用记录**
   - 在查询结果下方，点击"查看使用记录"按钮
   - 系统会自动加载该卡片的使用记录

3. **查看详细信息**
   - **基本信息**：卡号、状态
   - **金额信息**：余额（绿色）、已用金额（蓝色）
   - **交易明细**：
     - 交易序号
     - 商户名称
     - 交易金额（支出红色、退款绿色）
     - 交易时间
     - 交易状态

### 使用限制
- ⚠️ 只有已激活的卡片才能查询使用记录
- ⚠️ 未激活的卡片没有卡号，无法查询

### 显示效果
```
使用记录
├─ 卡号：5123 **** **** 1234
├─ 状态：active
├─ 余额：$8.50
└─ 已用：$1.50

交易明细 (2 笔)：
├─ #1 Amazon.com              -$0.99
│  时间: 2024-12-11 10:30:00
│  状态: completed
│
└─ #2 Netflix                 -$0.51
   时间: 2024-12-11 09:15:00
   状态: completed
```

### API 接口
```
GET /api/cards/{card_id}/transactions

响应：
{
  "success": true,
  "message": "查询成功",
  "data": {
    "card_number": "5123****1234",
    "status": "active",
    "balance": 8.50,
    "spent": 1.50,
    "transactions": [
      {
        "merchant": "Amazon.com",
        "amount": 0.99,
        "date": "2024-12-11T10:30:00Z",
        "status": "completed"
      }
    ]
  }
}
```

---

## 🎯 使用场景

### 批量激活适用场景
1. **批量开卡**：一次性开通多张新购买的卡片
2. **库存管理**：批量激活库存卡片
3. **快速部署**：需要快速准备多张卡片

### 查询使用记录适用场景
1. **账单核对**：核对卡片消费记录
2. **异常监控**：检查是否有异常交易
3. **余额查询**：查看卡片剩余额度
4. **对账管理**：与客户对账时查看交易明细

---

## ⚙️ 页面布局

```
查询并激活卡片
┌─────────────────────────────────────┐
│  [单张激活] [批量激活]              │  ← 模式切换
└─────────────────────────────────────┘

单张激活模式：
┌─────────────────────────────────────┐
│ 卡密：                              │
│ [___________________________]       │
│ [查询并自动激活]                    │
└─────────────────────────────────────┘
  ↓ 查询结果
┌─────────────────────────────────────┐
│ 卡片信息                            │
│ • 卡密、卡号、CVC等                 │
│ [查看使用记录]  ← 新增按钮           │
│   ↓                                 │
│ 使用记录（交易明细）                 │
└─────────────────────────────────────┘

批量激活模式：
┌─────────────────────────────────────┐
│ 批量卡密（每行一个）：               │
│ [                              ]    │
│ [                              ]    │
│ [                              ]    │
│ [批量激活]                          │
└─────────────────────────────────────┘
  ↓ 激活结果
┌─────────────────────────────────────┐
│ 批量激活进度                         │
│ 总数: 10 | 成功: 8 | 失败: 2        │
│ [████████████░░] 80%                │
│ 详细日志...                         │
└─────────────────────────────────────┘
```

---

## 🔧 技术实现

### 前端部分（index.html）

#### 新增HTML结构
- 模式切换按钮
- 批量激活输入框和结果显示区域
- 查看使用记录按钮
- 交易记录显示区域

#### 新增JavaScript函数
1. `switchQueryMode(mode)` - 切换单张/批量模式
2. `batchQueryActivate()` - 批量激活处理
3. `viewCardTransactions(cardId)` - 查询使用记录

### 后端部分（已有）

#### API端点
- `POST /api/cards/batch/activate` - 批量激活
- `GET /api/cards/{card_id}/transactions` - 查询使用记录

#### 核心函数（app/utils/activation.py）
- `get_card_transactions(card_number)` - 获取交易记录

---

## 📝 注意事项

1. **批量激活**
   - 建议每次激活不超过50张卡片
   - 失败的卡片会自动重试3次
   - 网络不稳定时建议降低并发数

2. **查询使用记录**
   - 只支持已激活的卡片
   - 需要等待激活成功后才能查询
   - 交易记录由第三方API提供，可能有延迟

3. **访客模式**
   - 无需登录即可使用查询激活功能
   - 包括单张激活、批量激活和查询使用记录
   - 其他管理功能需要登录后使用

---

## 🎉 更新日志

**版本：** 1.0  
**更新日期：** 2024-12-11  

### 新增功能
- ✅ 查询激活页面支持批量激活
- ✅ 查询结果支持查看使用记录
- ✅ 单张/批量模式一键切换
- ✅ 实时显示批量激活进度
- ✅ 详细的交易记录展示

### 优化改进
- 🔧 优化页面布局和用户体验
- 🔧 增强错误提示信息
- 🔧 改进加载状态显示

---

## 📞 问题反馈

如有问题或建议，请联系开发团队。

