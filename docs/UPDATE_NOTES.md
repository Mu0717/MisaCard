# 更新说明 - 使用状态功能

## 新增功能

### 1. 卡片使用状态标记
- ✅ 添加了 `is_used` (是否已使用) 和 `used_time` (使用时间) 字段
- ✅ 可以单独标记/取消标记卡片为已使用
- ✅ 支持批量标记卡片为已使用
- ✅ 在卡片列表和详情中显示使用状态

### 2. 一键选中功能
- ✅ 新增"一键选中已激活未使用"按钮
- ✅ 自动筛选并选中所有已激活且未使用的卡片
- ✅ 方便批量操作管理

### 3. 使用状态筛选
- ✅ 在筛选栏添加"使用状态"下拉框
- ✅ 可筛选：全部/已使用/未使用

## 数据库迁移

### 对于新安装用户
无需额外操作，直接运行初始化脚本即可：
```bash
python init_db.py init
```

### 对于现有用户（升级）
需要运行迁移脚本添加新字段：

**Windows:**
```bash
python migrate_add_used_field.py
```

**Linux/Mac:**
```bash
python3 migrate_add_used_field.py
# 或
chmod +x migrate_add_used_field.py
./migrate_add_used_field.py
```

迁移脚本会自动：
1. 检查是否已有 `is_used` 和 `used_time` 字段
2. 如果不存在则添加
3. 如果已存在则跳过（安全可重复执行）

### 验证迁移
运行以下命令检查数据库表结构：
```bash
python init_db.py check
```

应该能看到 `cards` 表包含以下新字段：
- `is_used: BOOLEAN`
- `used_time: TIMESTAMP`

## 使用方法

### 单个卡片操作
1. 在卡片列表中，每张卡片有"标记使用/取消使用"按钮
2. 点击"详情"查看卡片，也可以在详情页标记使用状态

### 批量操作
1. 点击"一键选中已激活未使用"按钮，自动选中所有符合条件的卡片
2. 或手动勾选需要操作的卡片
3. 点击"批量标记已使用"按钮
4. 确认后批量标记

### 筛选功能
在卡片列表页面：
1. 使用"使用状态"下拉框筛选
   - 全部使用状态：显示所有卡片
   - 已使用：只显示已标记为使用的卡片
   - 未使用：只显示未标记为使用的卡片
2. 可与其他筛选条件组合使用

## 典型使用场景

### 场景1：批量管理已激活卡片
1. 激活多张卡片
2. 点击"一键选中已激活未使用"
3. 将选中的卡片批量复制（格式：卡号|月|年|CVC）
4. 使用完毕后，点击"批量标记已使用"
5. 下次可以通过筛选器快速找到未使用的卡片

### 场景2：追踪卡片使用情况
1. 在"使用状态"筛选器中选择"未使用"
2. 查看所有未使用的已激活卡片
3. 选择需要的卡片进行操作
4. 使用后标记为已使用

## 注意事项

1. **数据迁移是安全的**：迁移脚本会先检查字段是否存在，不会重复添加
2. **可重复执行**：即使多次运行迁移脚本也不会出错
3. **默认值**：所有现有卡片的 `is_used` 默认为 `false`（未使用）
4. **时间记录**：只有标记为已使用时才会记录 `used_time`

## 技术细节

### 数据库变更
```sql
-- 添加字段
ALTER TABLE cards ADD COLUMN is_used BOOLEAN DEFAULT 0;
ALTER TABLE cards ADD COLUMN used_time TIMESTAMP;
```

### API端点
- `POST /api/cards/{card_id}/mark-used` - 切换卡片使用状态

### 前端变更
- 新增使用状态筛选器
- 新增使用状态列
- 新增批量标记已使用功能
- 新增一键选中已激活未使用功能

## 问题排查

### 问题1：迁移失败
**解决方案：**
1. 确保数据库文件 `cards.db` 存在
2. 检查是否有写入权限
3. 查看错误信息并根据提示操作

### 问题2：前端看不到新字段
**解决方案：**
1. 清空浏览器缓存
2. 强制刷新页面 (Ctrl+F5 或 Cmd+Shift+R)
3. 重启后端服务

### 问题3：标记使用后看不到变化
**解决方案：**
1. 点击"刷新"按钮重新加载卡片列表
2. 检查浏览器控制台是否有错误信息

## 反馈

如有问题或建议，请及时反馈。

