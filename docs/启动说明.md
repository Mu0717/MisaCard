# 🚀 重新启动服务以应用鉴权功能

## ⚠️ 重要提示
密码鉴权功能已完成实现，但需要重启服务才能生效！

## 📝 需要做的事情

### 1. 停止当前运行的服务
在运行 uvicorn 的终端中按 `Ctrl+C` 停止服务。

### 2. 确认依赖已安装
```bash
pip install python-jose[cryptography]
```

或者重新安装所有依赖：
```bash
pip install -r requirements.txt
```

### 3. 重新启动服务
```bash
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 4. 验证功能
启动成功后，应该能看到类似的输出：
```
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

## 🧪 快速测试

### 测试1: 访问 API 文档
浏览器打开: http://localhost:8000/docs

你应该能看到新增的 `/api/auth` 相关接口。

### 测试2: 运行自动化测试
```bash
python test_auth.py
```

### 测试3: 手动测试登录
```bash
curl -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/json" \
  -d "{\"password\": \"003717\"}"
```

应该返回：
```json
{
  "success": true,
  "message": "登录成功",
  "access_token": "eyJ...",
  "token_type": "bearer",
  "expires_in_hours": 24
}
```

### 测试4: 测试无需鉴权的激活功能
```bash
# 激活功能无需密码，应该可以正常访问
curl -X POST "http://localhost:8000/api/cards/test-card-id/activate"
```

### 测试5: 测试需要鉴权的列表功能
```bash
# 不带 Token 访问，应该返回 401 错误
curl -X GET "http://localhost:8000/api/cards/"
```

应该返回：
```json
{
  "detail": "未提供认证凭据"
}
```

## ✅ 功能检查清单

- [ ] 服务已重启
- [ ] 访问 /docs 能看到 auth 相关接口
- [ ] 登录接口返回 Token
- [ ] 激活功能无需 Token 可以访问
- [ ] 列表功能需要 Token 才能访问

## 📚 相关文档

- **AUTH_SUMMARY.md** - 完整的功能实现总结
- **README_AUTH.md** - 详细的使用文档
- **INSTALL_AUTH.md** - 安装和测试指南
- **test_auth.py** - 自动化测试脚本

## 🎯 实现的功能

### ✅ 已完成
1. 默认密码设置为 `003717`
2. 查询和激活功能**无需密码**
3. 其他功能**需要密码**
4. 基于 JWT Token 的认证系统
5. 完整的文档和测试

### 🔓 无需密码的功能
- `POST /api/cards/{card_id}/activate` - 激活卡片
- `POST /api/cards/batch/activate` - 批量激活
- `POST /api/cards/{card_id}/query` - 查询卡片

### 🔒 需要密码的功能
- 所有其他卡片管理功能
- 批量导入功能
- 消费记录查询
- 退款管理等

## ❓ 遇到问题？

### 问题1: ModuleNotFoundError: No module named 'jose'
**解决方案：**
```bash
pip install python-jose[cryptography]
```

### 问题2: 服务启动后仍然报错
**解决方案：**
1. 确保完全停止了旧的服务进程
2. 确认 python-jose 安装成功：`pip show python-jose`
3. 使用正确的 Python 环境（如果使用虚拟环境）

### 问题3: 登录失败
**检查：**
1. 密码是否正确（默认：`003717`）
2. 请求格式是否正确（JSON 格式）
3. Content-Type 是否设置为 `application/json`

## 📞 需要帮助？

查看详细文档：
- **AUTH_SUMMARY.md** - 功能总结和 API 列表
- **README_AUTH.md** - 使用指南和示例代码
- **INSTALL_AUTH.md** - 安装步骤和故障排除

---

**准备好了吗？开始重启服务吧！** 🚀
