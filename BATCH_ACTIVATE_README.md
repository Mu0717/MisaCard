# 批量激活功能优化说明

## 🚀 新功能特性

### 1. **并发处理**
- 支持同时发起多个激活请求
- 默认并发数：5（可在前端代码中调整 1-20）
- 大幅提升批量激活速度

### 2. **智能重试**
- 自动重试失败的激活请求
- 默认最大重试次数：3（可配置 0-10）
- 每次重试前会有延迟，避免过于频繁

### 3. **详细日志**
- 实时显示每个卡片的激活状态
- 区分成功和失败的卡片
- 显示重试次数和失败原因

### 4. **并发控制**
- 使用 asyncio.Semaphore 限制并发数
- 防止同时请求过多导致服务器压力
- 可根据服务器性能调整并发参数

## 📝 使用方法

### 前端使用
1. 在卡片列表中选择要激活的卡片
2. 点击"批量激活"按钮
3. 确认激活参数（并发数和重试次数）
4. 等待激活完成，查看详细日志

### API 使用

#### 批量激活接口
```bash
POST /api/cards/batch/activate
```

**请求体：**
```json
{
  "card_ids": ["卡密1", "卡密2", "卡密3"],
  "concurrency": 5,      // 并发数（1-20）
  "max_retries": 3       // 最大重试次数（0-10）
}
```

**响应：**
```json
{
  "success": true,
  "message": "批量激活完成: 成功 8/10",
  "data": {
    "total": 10,
    "success_count": 8,
    "failed_count": 2,
    "success": [
      {
        "card_id": "卡密1",
        "success": true,
        "message": "卡片已自动激活",
        "retry_count": 0
      }
    ],
    "failed": [
      {
        "card_id": "卡密9",
        "success": false,
        "message": "激活失败: 卡片状态为 未激活",
        "retry_count": 3
      }
    ]
  }
}
```

## ⚙️ 配置参数

### 前端配置（index.html）
在 `batchActivate()` 函数中修改：

```javascript
const concurrency = 5;  // 并发数，建议值: 3-10
const maxRetries = 3;   // 最大重试次数，建议值: 2-5
```

### 性能建议
- **小批量（<10张）**：并发数 3-5
- **中批量（10-50张）**：并发数 5-10
- **大批量（>50张）**：并发数 5-8，建议分批处理

### 服务器配置
如果遇到超时或连接问题，可以：
1. 降低并发数（如从 5 降到 3）
2. 增加请求超时时间（在 activation.py 中修改）
3. 调整重试延迟时间

## 📊 日志输出

### 控制台日志示例
```
############################################################
[批量激活] 开始批量激活 10 张卡片
[批量激活] 并发数: 5
[批量激活] 最大重试次数: 3
############################################################

************************************************************
[自动激活流程] 开始处理卡密: XXXX-XXXX-XXXX
************************************************************
[自动激活流程] 步骤1: 查询卡片信息...

============================================================
[查询卡片] 请求URL: https://...
[查询卡片] 响应状态码: 200
[查询卡片] 卡片状态: 未激活
============================================================

[自动激活流程] 步骤2: 检查激活状态...
[自动激活流程] 步骤3: 执行自动激活...

============================================================
[激活卡片] 请求URL: https://...
[激活卡片] 响应状态码: 200
[激活卡片] 卡片状态: 已激活
[激活卡片] ✓ 激活成功!
============================================================

[批量激活] ✓ 成功: XXXX-XXXX-XXXX

############################################################
[批量激活] 批量激活完成!
[批量激活] 总数: 10
[批量激活] 成功: 8
[批量激活] 失败: 2
############################################################
```

## 🔍 与旧版对比

| 功能 | 旧版（串行） | 新版（并发） |
|------|------------|------------|
| 处理方式 | 逐个激活 | 并发激活 |
| 速度 | 慢 | 快（提升3-5倍） |
| 重试机制 | 无限重试 | 可配置次数 |
| 暂停/继续 | 支持 | 不支持* |
| 进度追踪 | 实时 | 完成后统一显示 |
| 服务器压力 | 低 | 中（可控制） |

\* 并发模式下一旦开始就会持续到完成，不支持暂停

## 🛠️ 故障排除

### 问题：激活失败率高
**解决方案：**
- 降低并发数到 2-3
- 增加重试次数到 5
- 检查网络连接

### 问题：请求超时
**解决方案：**
- 降低并发数
- 增加超时时间（activation.py 中的 timeout 参数）
- 分批处理卡片

### 问题：服务器响应慢
**解决方案：**
- 减少并发数
- 增加请求间隔
- 优化服务器配置

## 📌 注意事项

1. **并发数不宜过高**：建议不超过 10，避免服务器压力过大
2. **网络稳定性**：并发请求对网络要求较高
3. **数据库连接**：高并发可能需要增加数据库连接池大小
4. **API 限流**：注意第三方 API 的频率限制

## 🔄 回退到旧版

如果需要使用旧版串行激活模式，可以注释掉新的 `processBatchActivate()` 函数，
取消注释旧版的处理逻辑（保留在代码中）。

---

**版本：** 2.0  
**更新日期：** 2024-12  
**作者：** AI Assistant

