<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>查询并激活</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-active {
      background-color: #d1fae5;
      color: #065f46;
    }

    .badge-inactive {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .badge-expired {
      background-color: #fef3c7;
      color: #92400e;
    }

    .badge-deleted {
      background-color: #e5e7eb;
      color: #374151;
    }

    /* Loading 样式 */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .loading-spinner {
      background: white;
      border-radius: 12px;
      padding: 24px 32px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">
  <!-- Loading Overlay -->
  <div id="globalLoading" class="loading-overlay">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <div class="text-gray-700 font-medium">处理中...</div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
    <div id="page-query" class="p-8 bg-white rounded-xl shadow-lg">
      <h2 class="text-3xl font-bold text-gray-800 mb-6">查询并激活卡片</h2>

      <!-- 切换单个/批量/卡号查询模式的按钮 -->
      <div class="max-w-2xl mb-4">
        <div class="bg-white rounded-lg shadow p-4 flex gap-3">
          <button id="singleModeBtn" onclick="switchQueryMode('single')"
            class="flex-1 py-2 px-4 rounded-lg font-semibold bg-blue-500 text-white hover:bg-blue-600 transition">
            单张激活
          </button>
          <button id="batchModeBtn" onclick="switchQueryMode('batch')"
            class="flex-1 py-2 px-4 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition">
            批量激活
          </button>
          <button id="cardNumberModeBtn" onclick="switchQueryMode('cardnumber')"
            class="flex-1 py-2 px-4 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition">
            卡号查询
          </button>
          <button id="emailModeBtn" onclick="switchQueryMode('email')"
            class="flex-1 py-2 px-4 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition">
            验证码
          </button>
        </div>
      </div>

      <div class="max-w-2xl">
        <!-- 单张激活模式 -->
        <div id="singleQueryMode">
          <div class="bg-white rounded-lg shadow p-6 mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">卡密</label>
            <input type="text" id="queryCardId" placeholder="请输入卡密 (例如: mio-xxxxx)"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" />
            <button onclick="queryCard()"
              class="w-full bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-600 transition">
              查询并自动激活
            </button>
          </div>
          <div id="queryResult" class="hidden"></div>
          <div id="queryError" class="hidden"></div>
        </div>

        <!-- 批量激活模式 -->
        <div id="batchQueryMode" class="hidden">
          <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
              <div class="flex items-start">
                <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                    clip-rule="evenodd"></path>
                </svg>
                <div>
                  <h4 class="text-sm font-semibold text-blue-800 mb-1">
                    批量激活说明
                  </h4>
                  <ul class="text-sm text-blue-700 space-y-1">
                    <li>✓ 支持同时激活多张卡片</li>
                    <li>✓ 每行输入一个卡密</li>
                    <li>✓ 自动并发处理，速度快</li>
                    <li>✓ 失败卡片会自动重试</li>
                  </ul>
                </div>
              </div>
            </div>
            <label class="block text-sm font-medium text-gray-700 mb-2">批量卡密（每行一个）</label>
            <textarea id="batchQueryCardIds" rows="10"
              placeholder="请输入卡密，每行一个&#10;&#10;示例：&#10;mio-xxxxx-xxxxx-xxxxx&#10;mio-yyyyy-yyyyy-yyyyy&#10;mio-zzzzz-zzzzz-zzzzz"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 mb-4 font-mono text-sm"></textarea>
            <button onclick="batchQueryActivate()"
              class="w-full bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600 transition">
              批量激活
            </button>
          </div>
          <div id="batchQueryResult" class="hidden"></div>
        </div>

        <!-- 卡号查询模式 -->
        <div id="cardNumberQueryMode" class="hidden">
          <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
              <div class="flex items-start">
                <svg class="w-5 h-5 text-purple-600 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                    clip-rule="evenodd"></path>
                </svg>
                <div>
                  <h4 class="text-sm font-semibold text-purple-800 mb-1">
                    卡号查询说明
                  </h4>
                  <ul class="text-sm text-purple-700 space-y-1">
                    <li>✓ 通过卡号查询交易明细</li>
                    <li>✓ 无需卡密，只需卡号</li>
                    <li>✓ 查看余额和消费记录</li>
                    <li>✓ 适用于已激活的卡片</li>
                  </ul>
                </div>
              </div>
            </div>
            <label class="block text-sm font-medium text-gray-700 mb-2">卡号</label>
            <input type="text" id="cardNumberInput" placeholder="请输入卡号 (例如: 5123456789012345)"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4" />
            <button onclick="queryTransactionsByCardNumber()"
              class="w-full bg-purple-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-600 transition">
              <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              查询交易明细
            </button>
          </div>
          <div id="cardNumberQueryResult" class="hidden"></div>
        </div>

        <!-- 验证码查询模式 -->
        <div id="emailQueryMode" class="hidden">
          <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
              <div class="flex items-start">
                <svg class="w-5 h-5 text-yellow-600 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                  <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                </svg>
                <div>
                  <h4 class="text-sm font-semibold text-yellow-800 mb-1">
                    验证码查询说明
                  </h4>
                  <ul class="text-sm text-yellow-700 space-y-1">
                    <li>✓ 获取最新的支付验证码邮件</li>
                    <li>✓ 自动解析邮件内容</li>
                    <li>✓ 10分钟内有效</li>
                  </ul>
                </div>
              </div>
            </div>

            <button onclick="queryEmails()"
              class="w-full bg-yellow-500 text-white px-4 py-2 rounded font-semibold text-sm hover:bg-yellow-600 transition">
              <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              刷新邮件
            </button>

            <!-- 过滤开关 -->
            <!--  <div id="emailControls" class="mt-3 flex justify-end hidden border-t border-gray-100 pt-2">
              <label class="inline-flex items-center cursor-pointer select-none">
                <input type="checkbox" id="onlyCodeFilter" onchange="renderEmails()" class="sr-only peer">
                <div
                  class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-500">
                </div>
                <span class="ms-2 text-xs font-medium text-gray-600">只看验证码</span>
              </label>
            </div> -->
          </div>
          <div id="emailQueryResult" class="hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== Loading 控制 ====================
    let loadingCount = 0;
    let fetchedEmails = []; // Store fetched emails

    function showLoading () {
      loadingCount++;
      const loadingEl = document.getElementById("globalLoading");
      if (loadingEl) {
        loadingEl.classList.add("active");
      }
    }

    function hideLoading () {
      loadingCount--;
      if (loadingCount <= 0) {
        loadingCount = 0;
        const loadingEl = document.getElementById("globalLoading");
        if (loadingEl) {
          loadingEl.classList.remove("active");
        }
      }
    }

    // ==================== 辅助函数 ====================
    function showToast (message, type = "info") {
      const toast = document.createElement("div");
      toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 fade-in ${type === "success"
        ? "bg-green-500"
        : type === "error"
          ? "bg-red-500"
          : "bg-blue-500"
        }`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transform = "translateY(-20px)";
        toast.style.transition = "all 0.3s ease";
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function formatDate (dateStr) {
      if (!dateStr) return "-";
      const date = new Date(dateStr);
      return date.toLocaleString("zh-CN", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    function getStatusBadge (status) {
      const badges = {
        active: '<span class="badge badge-active">已激活</span>',
        inactive: '<span class="badge badge-inactive">未激活</span>',
        expired: '<span class="badge badge-expired">已过期</span>',
        deleted: '<span class="badge badge-deleted">已删除</span>',
      };
      return badges[status] || '<span class="badge">' + status + "</span>";
    }

    // ==================== 业务逻辑 ====================

    function switchQueryMode (mode) {
      const singleMode = document.getElementById("singleQueryMode");
      const batchMode = document.getElementById("batchQueryMode");
      const cardNumberMode = document.getElementById("cardNumberQueryMode");
      const emailMode = document.getElementById("emailQueryMode");

      const singleBtn = document.getElementById("singleModeBtn");
      const batchBtn = document.getElementById("batchModeBtn");
      const cardNumberBtn = document.getElementById("cardNumberModeBtn");
      const emailBtn = document.getElementById("emailModeBtn");

      singleMode.classList.add("hidden");
      batchMode.classList.add("hidden");
      cardNumberMode.classList.add("hidden");
      if (emailMode) emailMode.classList.add("hidden");

      [singleBtn, batchBtn, cardNumberBtn, emailBtn].forEach((btn) => {
        if (!btn) return;
        btn.classList.remove(
          "bg-blue-500",
          "bg-green-500",
          "bg-purple-500",
          "bg-yellow-500",
          "text-white"
        );
        btn.classList.add("bg-gray-200", "text-gray-700");
      });

      if (mode === "single") {
        singleMode.classList.remove("hidden");
        singleBtn.classList.remove("bg-gray-200", "text-gray-700");
        singleBtn.classList.add("bg-blue-500", "text-white");
      } else if (mode === "batch") {
        batchMode.classList.remove("hidden");
        batchBtn.classList.remove("bg-gray-200", "text-gray-700");
        batchBtn.classList.add("bg-green-500", "text-white");
      } else if (mode === "cardnumber") {
        cardNumberMode.classList.remove("hidden");
        cardNumberBtn.classList.remove("bg-gray-200", "text-gray-700");
        cardNumberBtn.classList.add("bg-purple-500", "text-white");
      } else if (mode === "email") {
        if (emailMode) emailMode.classList.remove("hidden");
        if (emailBtn) {
          emailBtn.classList.remove("bg-gray-200", "text-gray-700");
          emailBtn.classList.add("bg-yellow-500", "text-white");
        }
      }
    }

    async function queryEmails () {
      showLoading();
      const resultDiv = document.getElementById("emailQueryResult");
      const controlsDiv = document.getElementById("emailControls");

      try {
        const response = await fetch("/api/cards/emails/list");
        const res = await response.json();

        resultDiv.classList.remove("hidden");

        if (res.success) {
          fetchedEmails = [];
          // Parse data structure
          if (res.data) {
            if (Array.isArray(res.data)) {
              fetchedEmails = res.data;
            } else if (res.data.items && Array.isArray(res.data.items)) {
              fetchedEmails = res.data.items;
            } else if (res.data.id || res.data.address) {
              fetchedEmails = [res.data];
            } else {
              if (Object.keys(res.data).length > 0) fetchedEmails = [res.data];
            }
          }

          if (fetchedEmails.length > 0 && controlsDiv) {
            controlsDiv.classList.remove("hidden");
          }

          if (fetchedEmails.length === 0) {
            if (controlsDiv) controlsDiv.classList.add("hidden");
            resultDiv.innerHTML = `
                  <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
                      <p class="text-gray-500">暂无邮件记录</p>
                  </div>`;
            showToast("未找到邮件", "info");
            return;
          }

          renderEmails();
          showToast("刷新成功", "success");

        } else {
          resultDiv.innerHTML = `<div class="bg-red-50 text-red-600 p-4 rounded-lg">获取失败: ${res.message}</div>`;
          showToast("获取失败: " + res.message, "error");
        }
      } catch (error) {
        console.error(error);
        resultDiv.classList.remove("hidden");
        resultDiv.innerHTML = `<div class="bg-red-50 text-red-600 p-4 rounded-lg">网络错误: ${error.message}</div>`;
        showToast("网络错误", "error");
      } finally {
        hideLoading();
      }
    }

    function renderEmails () {
      const resultDiv = document.getElementById("emailQueryResult");
      const onlyCode = document.getElementById("onlyCodeFilter")?.checked;

      let emailsToDisplay = fetchedEmails;
      if (onlyCode) {
        emailsToDisplay = fetchedEmails.filter(email => {
          const content = ((email.preview || "") + (email.subject || "")).toLowerCase();
          // 必须同时包含数字和验证码关键词，防止匹配到包含年份或金额的普通邮件
          const hasNumber = /\d{4,8}/.test(content);
          const hasKeyword = /验证码|verification|code/.test(content);
          return hasNumber && hasKeyword;
        });
      }

      if (emailsToDisplay.length === 0) {
        resultDiv.innerHTML = `
                  <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
                      <p class="text-gray-500">
                        ${onlyCode ? "没有找到包含验证码的邮件" : "暂无邮件记录"}
                      </p>
                  </div>`;
        return;
      }

      let html = `<div class="space-y-4">`;

      emailsToDisplay.forEach(email => {
        const time = email.time ? formatDate(email.time) : "未知时间";
        let preview = email.preview || email.body || "无内容";
        // Highlight verification codes (4-8 digits)
        preview = preview.replace(/(\d{4,8})/g, '<span class="bg-yellow-200 font-bold px-1 rounded text-gray-900">$1</span>');

        html += `
                <div class="bg-white rounded p-4 shadow-sm border border-gray-100 hover:shadow-md transition">
                    <div class="flex justify-between items-baseline mb-1">
                        <div class="text-sm">
                            <span class="font-bold text-gray-800">${email.from || "System"}</span> 
                            <span class="text-gray-500 text-xs ml-1">&lt;${email.address || "-"}&gt;</span>
                        </div>
                        <div class="text-gray-400 text-xs whitespace-nowrap ml-2">${time}</div>
                    </div>
                    
                    <div class="text-base text-gray-800 font-medium mb-1 leading-snug">
                        ${email.subject || "No Subject"}
                    </div>
                    
                    <div class="text-gray-500 text-xs truncate font-mono">
                        ${preview}
                    </div>
                </div>
                `;
      });
      html += `</div>`;
      resultDiv.innerHTML = html;
    }

    async function queryCard () {
      const cardId = document.getElementById("queryCardId").value.trim();
      if (!cardId) {
        alert("请输入卡密");
        return;
      }

      showLoading();
      try {
        const response = await fetch(`/api/cards/${cardId}/activate`, {
          method: "POST",
        });
        const data = await response.json();

        if (response.ok && data.success) {
          displayQueryResult(data.card_data);
        } else {
          displayQueryError(data.detail || data.message || "查询失败");
        }
      } catch (error) {
        displayQueryError("网络错误: " + error.message);
      } finally {
        hideLoading();
      }
    }

    function displayQueryResult (card) {
      const resultDiv = document.getElementById("queryResult");
      const errorDiv = document.getElementById("queryError");

      errorDiv.classList.add("hidden");
      resultDiv.classList.remove("hidden");
      resultDiv.innerHTML = `
                <div class="bg-white rounded-lg shadow p-6 fade-in">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">卡片信息</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><span class="text-gray-600">卡密：</span><span class="font-semibold">${card.card_id
        }</span></div>
                        <div><span class="text-gray-600">卡号：</span><span class="font-semibold">${card.card_number || "未激活"
        }</span></div>
                        <div><span class="text-gray-600">CVC：</span><span class="font-semibold">${card.card_cvc || "未激活"
        }</span></div>
                        <div><span class="text-gray-600">有效期：</span><span class="font-semibold">${card.card_exp_date || "未激活"
        }</span></div>
                        <div><span class="text-gray-600">额度：</span><span class="font-semibold">$${card.card_limit
        }</span></div>
                        <div><span class="text-gray-600">状态：</span>${getStatusBadge(
          card.status
        )}</div>
                        <div><span class="text-gray-600">激活时间：</span><span class="font-semibold">${card.exp_date
          ? formatDate(
            new Date(
              new Date(card.exp_date).getTime() -
              1 * 60 * 60 * 1000
            )
          )
          : "-"
        }</span></div>
                        ${card.card_activation_time
          ? `<div><span class="text-gray-600">过期时间：</span><span class="font-semibold">${formatDate(
            card.exp_date
          )}</span></div>`
          : ""
        }
                        <div class="col-span-1 md:col-span-2 mt-2 pt-2 border-t border-gray-100">
                            <span class="text-gray-600 block mb-1">账单地址：</span>
                            <span class="font-mono text-sm break-all bg-gray-50 px-2 py-1 rounded block">${card.billing_address || "暂无信息"
        }</span>
                        </div>
                    </div>
                    ${card.card_number
          ? `
                    <button
                        onclick="viewCardTransactions('${card.card_id}')"
                        class="w-full mt-4 bg-indigo-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-600 transition"
                    >
                        <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        查看使用记录
                    </button>
                    `
          : ""
        }
                    <div id="transactionsResult" class="mt-4"></div>
                </div>
            `;
    }

    function displayQueryError (message) {
      const resultDiv = document.getElementById("queryResult");
      const errorDiv = document.getElementById("queryError");

      resultDiv.classList.add("hidden");
      errorDiv.classList.remove("hidden");
      errorDiv.innerHTML = `
                <div class="bg-red-50 border border-red-300 text-red-700 px-4 py-3 rounded-lg">
                    ${message}
                </div>
            `;
    }

    async function batchQueryActivate () {
      const textarea = document.getElementById("batchQueryCardIds");
      const content = textarea.value.trim();

      if (!content) {
        showToast("请输入卡密", "error");
        return;
      }

      const cardIds = content
        .split(/[\r\n]+/)
        .map((line) => line.trim())
        .filter((line) => line.length > 0);

      if (cardIds.length === 0) {
        showToast("未找到有效的卡密", "error");
        return;
      }

      const concurrency = 5;
      const maxRetries = 3;

      // Note: Using prompt/confirm here as in index.html
      if (
        !confirm(
          `确定要批量激活 ${cardIds.length} 张卡片吗？\n\n并发数: ${concurrency}\n最大重试: ${maxRetries} 次`
        )
      ) {
        return;
      }

      const resultDiv = document.getElementById("batchQueryResult");
      resultDiv.classList.remove("hidden");
      resultDiv.innerHTML = `
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">批量激活进度</h3>
                    <div class="mb-4">
                        <div class="text-sm text-gray-600 mb-2">正在激活...</div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>总数: <span class="font-semibold">${cardIds.length}</span></span>
                            <span>成功: <span id="batchQuerySuccess" class="font-semibold text-green-600">0</span></span>
                            <span>失败: <span id="batchQueryFailed" class="font-semibold text-red-600">0</span></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="batchQueryProgressBar" class="bg-blue-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="batchQueryLog" class="bg-gray-50 border border-gray-200 rounded p-4 max-h-96 overflow-y-auto text-sm font-mono"></div>
                </div>
            `;

      showLoading();
      try {
        const response = await fetch("/api/cards/batch/activate", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            card_ids: cardIds,
            concurrency: concurrency,
            max_retries: maxRetries,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || "批量激活请求失败");
        }

        document.getElementById("batchQuerySuccess").textContent =
          data.data.success_count;
        document.getElementById("batchQueryFailed").textContent =
          data.data.failed_count;
        document.getElementById("batchQueryProgressBar").style.width = "100%";

        const logDiv = document.getElementById("batchQueryLog");
        let logHtml = `<div class="text-green-600 font-semibold mb-2">✅ 批量激活完成！</div>`;
        logHtml += `<div class="mb-3">总数: ${data.data.total} | 成功: ${data.data.success_count} | 失败: ${data.data.failed_count}</div>`;

        if (data.data.success && data.data.success.length > 0) {
          logHtml += `<div class="text-green-600 font-semibold mt-3 mb-2">成功激活的卡片:</div>`;
          logHtml += `<div id="successCardsList" class="space-y-2"></div>`;
        }

        if (data.data.failed && data.data.failed.length > 0) {
          logHtml += `<div class="text-red-600 font-semibold mt-3 mb-2">失败的卡片:</div>`;
          data.data.failed.forEach((item) => {
            logHtml += `<div class="text-red-600 text-xs">✗ ${item.card_id}: ${item.message}</div>`;
          });
        }

        logDiv.innerHTML = logHtml;

        if (data.data.success && data.data.success.length > 0) {
          const successListDiv = document.getElementById("successCardsList");
          for (const item of data.data.success) {
            try {
              const cardResponse = await fetch(
                `/api/cards/${item.card_id}/query`,
                {
                  method: "POST",
                }
              );
              if (cardResponse.ok) {
                const responseData = await cardResponse.json();
                const cardData = responseData.card_data;
                const retryText =
                  item.retry_count > 0 ? ` (重试${item.retry_count}次)` : "";
                const cardInfoHtml = `
                                    <div class="bg-green-50 border border-green-200 rounded p-3 text-xs">
                                        <div class="font-semibold text-green-700 mb-2">✓ ${item.card_id
                  }${retryText}</div>
                                        <div class="grid grid-cols-2 gap-2 text-gray-700">
                                            <div><span class="text-gray-600">卡号:</span> ${cardData.card_number || "N/A"
                  }</div>
                                            <div><span class="text-gray-600">CVC:</span> ${cardData.card_cvc || "N/A"
                  }</div>
                                            <div><span class="text-gray-600">有效期:</span> ${cardData.card_exp_date || "N/A"
                  }</div>
                                            <div><span class="text-gray-600">额度:</span> $${cardData.card_limit || 0
                  }</div>
                                            <div class="col-span-2 border-t pt-1 mt-1"><span class="text-gray-600">账单地址:</span> <span class="font-mono text-xs select-all">${cardData.billing_address || "N/A"
                  }</span></div>
                                        </div>
                                        <button onclick="viewCardTransactionsByCardId('${item.card_id
                  }')" 
                                                class="mt-2 w-full bg-indigo-500 text-white px-3 py-1 rounded text-xs hover:bg-indigo-600 transition">
                                            查看使用记录
                                        </button>
                                        <div id="transactions-${item.card_id
                  }" class="mt-2"></div>
                                    </div>
                                `;
                successListDiv.innerHTML += cardInfoHtml;
              } else {
                successListDiv.innerHTML += `<div class="text-green-600 text-xs">✓ ${item.card_id
                  }${item.retry_count > 0 ? ` (重试${item.retry_count}次)` : ""
                  }</div>`;
              }
            } catch (error) {
              successListDiv.innerHTML += `<div class="text-green-600 text-xs">✓ ${item.card_id
                }${item.retry_count > 0 ? ` (重试${item.retry_count}次)` : ""
                }</div>`;
            }
          }
        }

        showToast(
          `批量激活完成！成功: ${data.data.success_count}, 失败: ${data.data.failed_count}`,
          data.data.failed_count === 0 ? "success" : "warning"
        );

        if (data.data.failed_count === 0) {
          textarea.value = "";
        }
      } catch (error) {
        console.error("批量激活错误:", error);
        const logDiv = document.getElementById("batchQueryLog");
        if (logDiv) {
          logDiv.innerHTML = `<div class="text-red-600 font-semibold">❌ 批量激活失败: ${error.message}</div>`;
        }
        showToast(`批量激活失败: ${error.message}`, "error");
      } finally {
        hideLoading();
      }
    }

    async function viewCardTransactions (cardId) {
      const transactionsDiv = document.getElementById("transactionsResult");
      transactionsDiv.innerHTML = `
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-center">
                        <div class="spinner w-5 h-5 mr-3 border-2"></div>
                        正在加载使用记录...
                    </div>
                </div>
            `;

      try {
        const response = await fetch(
          `/api/cards/${cardId}/transactions/query`,
          {
            method: "POST",
          }
        );

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || "查询失败");
        }

        const data = await response.json();
        const cardInfo = data.data;

        let html = `<div class="bg-white border border-gray-300 rounded-lg p-4 mt-4">`;
        html += `<h4 class="text-lg font-bold mb-3 text-gray-800">使用记录</h4>`;

        html += `<div class="mb-4 pb-4 border-b border-gray-200">`;
        html += `<div class="grid grid-cols-2 gap-3 text-sm">`;
        html += `<div><span class="text-gray-600">卡号：</span><span class="font-semibold">${cardInfo.card_number || "N/A"
          }</span></div>`;
        html += `<div><span class="text-gray-600">状态：</span><span class="font-semibold">${cardInfo.status || "N/A"
          }</span></div>`;
        html += `<div><span class="text-gray-600">余额：</span><span class="font-semibold text-green-600">$${cardInfo.available !== undefined ? cardInfo.available : "N/A"
          }</span></div>`;
        html += `<div><span class="text-gray-600">已用：</span><span class="font-semibold text-blue-600">$${cardInfo.pending !== undefined ? cardInfo.pending : "N/A"
          }</span></div>`;
        html += `</div>`;
        html += `</div>`;

        if (cardInfo.transactions && cardInfo.transactions.length > 0) {
          html += `<div class="space-y-3">`;
          html += `<h5 class="font-semibold text-gray-700">交易明细 (${cardInfo.transactions.length} 笔)：</h5>`;
          cardInfo.transactions.forEach((tx, index) => {
            html += `<div class="bg-gray-50 rounded p-3 text-sm">`;
            html += `<div class="flex justify-between items-start mb-2">`;
            html += `<span class="font-semibold text-gray-800">#${index + 1
              } ${tx.merchant || tx.bank_description || "未知商户"}</span>`;
            html += `<span class="font-bold ${tx.amount > 0 ? "text-red-600" : "text-green-600"
              }">$${Math.abs(tx.amount || 0).toFixed(2)}</span>`;
            html += `</div>`;
            html += `<div class="text-gray-600">`;
            if (tx.date) html += `<div>时间: ${formatDate(tx.date)}</div>`;
            if (tx.status) html += `<div>状态: ${tx.status}</div>`;
            html += `</div>`;
            html += `</div>`;
          });
          html += `</div>`;
        } else {
          html += `<div class="text-center text-gray-500 py-4">暂无交易记录</div>`;
        }

        html += `</div>`;
        transactionsDiv.innerHTML = html;
      } catch (error) {
        console.error("查询使用记录错误:", error);
        transactionsDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-300 text-red-700 px-4 py-3 rounded-lg mt-4">
                        查询使用记录失败: ${error.message}
                    </div>
                `;
      }
    }

    async function viewCardTransactionsByCardId (cardId) {
      const transactionsDiv = document.getElementById(
        `transactions-${cardId}`
      );
      transactionsDiv.innerHTML = `
                <div class="bg-gray-100 border border-gray-300 rounded p-2 text-xs">
                    <div class="flex items-center justify-center py-2">
                        <div class="spinner w-4 h-4 mr-2 border-2"></div>
                        加载中...
                    </div>
                </div>
            `;

      try {
        const response = await fetch(
          `/api/cards/${cardId}/transactions/query`,
          {
            method: "POST",
          }
        );

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || "查询失败");
        }

        const data = await response.json();
        const cardInfo = data.data;
        let html = `<div class="bg-white border border-gray-300 rounded p-3">`;
        html += `<h5 class="text-xs font-bold mb-2 text-gray-800">使用记录</h5>`;

        html += `<div class="mb-2 pb-2 border-b border-gray-200">`;
        html += `<div class="grid grid-cols-2 gap-2 text-xs">`;
        html += `<div><span class="text-gray-600">卡号:</span> ${cardInfo.card_number || "N/A"
          }</div>`;
        html += `<div><span class="text-gray-600">状态:</span> ${cardInfo.status || "N/A"
          }</div>`;
        html += `<div><span class="text-gray-600">余额:</span> <span class="text-green-600 font-semibold">$${cardInfo.balance !== undefined ? cardInfo.balance : "N/A"
          }</span></div>`;
        html += `<div><span class="text-gray-600">已用:</span> <span class="text-blue-600 font-semibold">$${cardInfo.pending !== undefined ? cardInfo.pending : "N/A"
          }</span></div>`;
        html += `</div>`;
        html += `</div>`;

        if (cardInfo.transactions && cardInfo.transactions.length > 0) {
          html += `<div class="space-y-2">`;
          html += `<div class="text-xs font-semibold text-gray-700">交易明细 (${cardInfo.transactions.length} 笔):</div>`;
          cardInfo.transactions.forEach((tx, index) => {
            html += `<div class="bg-gray-50 rounded p-2 text-xs">`;
            html += `<div class="flex justify-between items-start mb-1">`;
            html += `<span class="font-semibold text-gray-800">#${index + 1
              } ${tx.merchant || tx.bank_description || "未知"}</span>`;
            html += `<span class="font-bold ${tx.amount > 0 ? "text-red-600" : "text-green-600"
              }">$${Math.abs(tx.amount || 0).toFixed(2)}</span>`;
            html += `</div>`;
            if (tx.date)
              html += `<div class="text-gray-600">时间: ${formatDate(
                tx.date
              )}</div>`;
            if (tx.status)
              html += `<div class="text-gray-600">状态: ${tx.status}</div>`;
            html += `</div>`;
          });
          html += `</div>`;
        } else {
          html += `<div class="text-center text-gray-500 py-2 text-xs">暂无交易记录</div>`;
        }

        html += `</div>`;
        transactionsDiv.innerHTML = html;
      } catch (error) {
        console.error("查询使用记录错误:", error);
        transactionsDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-300 text-red-700 px-2 py-2 rounded text-xs">
                        查询失败: ${error.message}
                    </div>
                `;
      }
    }

    async function queryTransactionsByCardNumber () {
      const cardNumber = document
        .getElementById("cardNumberInput")
        .value.trim();

      if (!cardNumber) {
        showToast("请输入卡号", "error");
        return;
      }

      const resultDiv = document.getElementById("cardNumberQueryResult");
      resultDiv.classList.remove("hidden");
      resultDiv.innerHTML = `
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-center py-8">
                         <div class="spinner w-8 h-8 mr-3 border-4"></div>
                        <span class="text-gray-600">正在查询交易明细...</span>
                    </div>
                </div>
            `;

      try {
        const response = await fetch(
          `/api/cards/query-by-card-number/${cardNumber}`,
          {
            method: "POST",
          }
        );

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || "查询失败");
        }

        const data = await response.json();
        const cardInfo = data.data;

        let html = `<div class="bg-white rounded-lg shadow p-6">`;
        html += `<h3 class="text-xl font-bold mb-4 text-gray-800 flex items-center">`;
        html += `<svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>`;
        html += `交易明细</h3>`;

        html += `<div class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-4 mb-4">`;
        html += `<div class="grid grid-cols-2 gap-4 text-sm">`;
        html += `<div><span class="text-gray-600">卡号：</span><span class="font-semibold text-gray-800">${cardInfo.card_number || cardNumber
          }</span></div>`;
        html += `<div><span class="text-gray-600">状态：</span><span class="font-semibold">${getStatusBadge(
          cardInfo.status || "N/A"
        )}</span></div>`;
        html += `<div><span class="text-gray-600">余额：</span><span class="font-bold text-green-600 text-lg">$${cardInfo.available !== undefined
          ? cardInfo.available.toFixed(2)
          : "N/A"
          }</span></div>`;
        html += `<div><span class="text-gray-600">已用：</span><span class="font-bold text-blue-600 text-lg">$${cardInfo.pending !== undefined ? cardInfo.pending.toFixed(2) : "N/A"
          }</span></div>`;
        if (cardInfo.card_limit !== undefined) {
          html += `<div><span class="text-gray-600">额度：</span><span class="font-semibold text-gray-800">$${cardInfo.card_limit}</span></div>`;
        }
        if (cardInfo.card_exp_date) {
          html += `<div><span class="text-gray-600">有效期：</span><span class="font-semibold text-gray-800">${cardInfo.card_exp_date}</span></div>`;
        }
        html += `</div>`;
        html += `</div>`;

        if (cardInfo.transactions && cardInfo.transactions.length > 0) {
          html += `<div class="mb-3">`;
          html += `<h4 class="font-bold text-gray-800 mb-3 flex items-center">`;
          html += `<svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>`;
          html += `交易记录 (${cardInfo.transactions.length} 笔)</h4>`;
          html += `<div class="space-y-3">`;

          cardInfo.transactions.forEach((tx, index) => {
            html += `<div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition">`;
            html += `<div class="flex justify-between items-start mb-2">`;
            html += `<div class="flex-1">`;
            html += `<div class="font-bold text-gray-800 text-base">#${index + 1
              } ${tx.merchant || tx.bank_description || "未知商户"}</div>`;
            if (tx.category)
              html += `<div class="text-xs text-gray-500 mt-1">${tx.category}</div>`;
            html += `</div>`;
            html += `<div class="text-right ml-4">`;
            html += `<div class="font-bold text-lg ">`;
            html += `${tx.amount}`;
            html += `</div>`;
            html += `</div>`;
            html += `</div>`;
            html += `<div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mt-2 pt-2 border-t border-gray-100">`;
            if (tx.date)
              html += `<div><svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>${formatDate(
                tx.date
              )}</div>`;
            if (tx.status)
              html += `<div><svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>${tx.status}</div>`;
            html += `</div>`;
            if (tx.reason_for_failure) {
              html += `<div class="mt-2 pt-2 border-t border-gray-100">`;
              html += `<p class="text-xs text-red-600"><span class="font-semibold">失败原因：</span>${tx.reason_for_failure}</p>`;
              html += `</div>`;
            }
            html += `</div>`;
          });

          html += `</div>`;
          html += `</div>`;
        } else {
          html += `<div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">`;
          html += `<svg class="w-16 h-16 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>`;
          html += `<p class="text-gray-500 text-lg font-semibold">暂无交易记录</p>`;
          html += `<p class="text-gray-400 text-sm mt-2">该卡片还没有任何交易</p>`;
          html += `</div>`;
        }

        html += `</div>`;
        resultDiv.innerHTML = html;

        showToast("查询成功", "success");
      } catch (error) {
        console.error("查询交易明细错误:", error);
        resultDiv.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="bg-red-50 border border-red-300 text-red-700 px-4 py-3 rounded-lg">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 mr-2 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                </svg>
                                <div>
                                    <h4 class="font-bold mb-1">查询失败</h4>
                                    <p>${error.message}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        showToast(`查询失败: ${error.message}`, "error");
      }
    }
  </script>
</body>

</html>