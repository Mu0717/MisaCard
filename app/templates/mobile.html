<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>å‘å¡ç³»ç»Ÿ - ç§»åŠ¨ç«¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      * {
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 100%;
        padding: 1rem;
      }

      .card {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 1rem;
      }

      .btn {
        width: 100%;
        padding: 1rem;
        border-radius: 0.75rem;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:active {
        transform: scale(0.98);
        opacity: 0.9;
      }

      .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }

      .btn-success:active {
        transform: scale(0.98);
        opacity: 0.9;
      }

      .btn-purple {
        background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
        color: white;
      }

      .btn-purple:active {
        transform: scale(0.98);
        opacity: 0.9;
      }

      .input-field {
        width: 100%;
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        font-size: 1rem;
        transition: border-color 0.2s;
      }

      .input-field:focus {
        outline: none;
        border-color: #667eea;
      }

      .tab-btn {
        flex: 1;
        padding: 0.75rem;
        background: #f3f4f6;
        color: #6b7280;
        border: none;
        font-weight: 600;
        transition: all 0.2s;
        cursor: pointer;
      }

      .tab-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .tab-btn:first-child {
        border-radius: 0.75rem 0 0 0.75rem;
      }

      .tab-btn:last-child {
        border-radius: 0 0.75rem 0.75rem 0;
      }

      .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .badge-success {
        background-color: #d1fae5;
        color: #065f46;
      }

      .badge-error {
        background-color: #fee2e2;
        color: #991b1b;
      }

      .badge-warning {
        background-color: #fef3c7;
        color: #92400e;
      }

      .loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      }

      .loading.active {
        display: flex;
      }

      .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid #f3f4f6;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .fade-in {
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .result-card {
        background: #f9fafb;
        border-radius: 0.75rem;
        padding: 1rem;
        margin-top: 1rem;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e5e7eb;
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        color: #6b7280;
        font-size: 0.875rem;
      }

      .info-value {
        color: #111827;
        font-weight: 600;
        font-size: 0.875rem;
        text-align: right;
        word-break: break-all;
      }

      .header {
        background: white;
        padding: 1rem;
        border-radius: 1rem;
        margin-bottom: 1rem;
        text-align: center;
      }

      .header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .alert {
        padding: 1rem;
        border-radius: 0.75rem;
        margin-bottom: 1rem;
      }

      .alert-info {
        background: #dbeafe;
        border: 1px solid #3b82f6;
        color: #1e40af;
      }

      .alert-success {
        background: #d1fae5;
        border: 1px solid #10b981;
        color: #065f46;
      }

      .alert-error {
        background: #fee2e2;
        border: 1px solid #ef4444;
        color: #991b1b;
      }

      .transaction-item {
        background: white;
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border: 1px solid #e5e7eb;
      }

      .transaction-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }

      .transaction-merchant {
        font-weight: 600;
        color: #111827;
        font-size: 0.875rem;
      }

      .transaction-amount {
        font-weight: 700;
        font-size: 1rem;
      }

      .transaction-amount.positive {
        color: #10b981;
      }

      .transaction-amount.negative {
        color: #ef4444;
      }

      .transaction-details {
        font-size: 0.75rem;
        color: #6b7280;
      }

      textarea {
        font-family: "Courier New", monospace;
      }
    </style>
  </head>
  <body>
    <!-- Loading -->
    <div id="loading" class="loading">
      <div
        style="
          background: white;
          border-radius: 1rem;
          padding: 2rem;
          text-align: center;
        "
      >
        <div class="spinner" style="margin: 0 auto 1rem"></div>
        <p style="color: #6b7280; font-weight: 600">åŠ è½½ä¸­...</p>
      </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="container" style="display: block">
      <div class="header">
        <h1>ğŸ´ å‘å¡ç³»ç»Ÿ</h1>
        <p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem">
          ç§»åŠ¨ç«¯ç®¡ç†
        </p>
      </div>

      <div class="card">
        <h2
          style="
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #111827;
          "
        >
          ç™»å½•
        </h2>
        <form onsubmit="handleLogin(event)">
          <label
            style="
              display: block;
              font-weight: 600;
              color: #374151;
              margin-bottom: 0.5rem;
              font-size: 0.875rem;
            "
          >
            è´¦å·
          </label>
          <input
            type="text"
            id="loginUsername"
            class="input-field"
            placeholder="è¯·è¾“å…¥è´¦å·"
            style="margin-bottom: 1rem"
            required
          />
          <label
            style="
              display: block;
              font-weight: 600;
              color: #374151;
              margin-bottom: 0.5rem;
              font-size: 0.875rem;
            "
          >
            å¯†ç 
          </label>
          <input
            type="password"
            id="loginPassword"
            class="input-field"
            placeholder="è¯·è¾“å…¥å¯†ç "
            style="margin-bottom: 1rem"
            required
          />
          <div
            id="loginError"
            class="alert alert-error"
            style="display: none; margin-bottom: 1rem"
          ></div>
          <button type="submit" class="btn btn-primary">ğŸ” ç™»å½•</button>
        </form>
      </div>

      <div
        class="card"
        style="
          background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
          border: 2px solid #3b82f6;
        "
      >
        <div style="text-align: center">
          <h3
            style="
              font-weight: 700;
              color: #1e40af;
              margin-bottom: 0.5rem;
              font-size: 0.875rem;
            "
          >
            ğŸ’¡ è®¿å®¢æ¨¡å¼
          </h3>
          <p style="color: #1e3a8a; font-size: 0.875rem; margin-bottom: 1rem">
            æ— éœ€ç™»å½•å³å¯ä½¿ç”¨æŸ¥è¯¢æ¿€æ´»åŠŸèƒ½
          </p>
          <button
            onclick="enterGuestMode()"
            class="btn btn-success"
            style="
              background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            "
          >
            ğŸ‘¤ è®¿å®¢æ¨¡å¼
          </button>
        </div>
      </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="container" style="display: none">
      <!-- Header -->
      <div class="header">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <h1>ğŸ´ å‘å¡ç³»ç»Ÿ</h1>
            <p
              style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem"
              id="userInfo"
            >
              ç§»åŠ¨ç«¯æŸ¥è¯¢æ¿€æ´»
            </p>
          </div>
          <button
            id="logoutBtn"
            onclick="handleLogout()"
            style="
              display: none;
              padding: 0.5rem 1rem;
              background: #ef4444;
              color: white;
              border: none;
              border-radius: 0.5rem;
              font-weight: 600;
              font-size: 0.75rem;
            "
          >
            é€€å‡º
          </button>
        </div>
      </div>

      <!-- Tab Switcher -->
      <div class="card" style="padding: 0.5rem">
        <div style="display: flex; gap: 0; flex-wrap: wrap">
          <button
            class="tab-btn active"
            onclick="switchTab('single')"
            id="tab-single"
            style="flex: 1 1 50%"
          >
            å•å¼ æ¿€æ´»
          </button>
          <button
            class="tab-btn"
            onclick="switchTab('batch')"
            id="tab-batch"
            style="flex: 1 1 50%"
          >
            æ‰¹é‡æ¿€æ´»
          </button>
          <button
            class="tab-btn"
            onclick="switchTab('query')"
            id="tab-query"
            style="flex: 1 1 50%; border-radius: 0 0 0 0.75rem"
          >
            å¡å·æŸ¥è¯¢
          </button>
          <button
            class="tab-btn"
            onclick="switchTab('cards')"
            id="tab-cards"
            style="display: none; flex: 1 1 50%; border-radius: 0 0 0.75rem 0"
          >
            å¡ç‰‡åˆ—è¡¨
          </button>
        </div>
      </div>

      <!-- Single Card Activation -->
      <div id="content-single" class="tab-content">
        <div class="card">
          <h2
            style="
              font-size: 1.25rem;
              font-weight: 700;
              margin-bottom: 1rem;
              color: #111827;
            "
          >
            å•å¼ å¡ç‰‡æ¿€æ´»
          </h2>
          <div class="alert alert-info" style="font-size: 0.875rem">
            <strong>ğŸ’¡ æç¤ºï¼š</strong>è¾“å…¥å¡å¯†åè‡ªåŠ¨æŸ¥è¯¢å¹¶æ¿€æ´»å¡ç‰‡
          </div>
          <label
            style="
              display: block;
              font-weight: 600;
              color: #374151;
              margin-bottom: 0.5rem;
              font-size: 0.875rem;
            "
          >
            å¡å¯†
          </label>
          <input
            type="text"
            id="singleCardId"
            class="input-field"
            placeholder="è¯·è¾“å…¥å¡å¯† (ä¾‹å¦‚: mio-xxxxx)"
            style="margin-bottom: 1rem"
          />
          <button class="btn btn-primary" onclick="activateSingleCard()">
            ğŸš€ æŸ¥è¯¢å¹¶æ¿€æ´»
          </button>
        </div>

        <!-- Single Card Result -->
        <div id="singleResult"></div>
      </div>

      <!-- Batch Activation -->
      <div id="content-batch" class="tab-content" style="display: none">
        <div class="card">
          <h2
            style="
              font-size: 1.25rem;
              font-weight: 700;
              margin-bottom: 1rem;
              color: #111827;
            "
          >
            æ‰¹é‡å¡ç‰‡æ¿€æ´»
          </h2>
          <div class="alert alert-info" style="font-size: 0.875rem">
            <strong>ğŸ’¡ è¯´æ˜ï¼š</strong>
            <ul style="margin-top: 0.5rem; padding-left: 1.25rem">
              <li>æ¯è¡Œè¾“å…¥ä¸€ä¸ªå¡å¯†</li>
              <li>è‡ªåŠ¨å¹¶å‘å¤„ç†ï¼Œé€Ÿåº¦å¿«</li>
              <li>å¤±è´¥å¡ç‰‡ä¼šè‡ªåŠ¨é‡è¯•</li>
            </ul>
          </div>
          <label
            style="
              display: block;
              font-weight: 600;
              color: #374151;
              margin-bottom: 0.5rem;
              font-size: 0.875rem;
            "
          >
            æ‰¹é‡å¡å¯†ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
          </label>
          <textarea
            id="batchCardIds"
            class="input-field"
            rows="8"
            placeholder="è¯·è¾“å…¥å¡å¯†ï¼Œæ¯è¡Œä¸€ä¸ª&#10;&#10;ç¤ºä¾‹ï¼š&#10;mio-xxxxx-xxxxx-xxxxx&#10;mio-yyyyy-yyyyy-yyyyy&#10;mio-zzzzz-zzzzz-zzzzz"
            style="margin-bottom: 1rem; resize: vertical"
          ></textarea>
          <button class="btn btn-success" onclick="activateBatchCards()">
            âš¡ æ‰¹é‡æ¿€æ´»
          </button>
        </div>

        <!-- Batch Result -->
        <div id="batchResult"></div>
      </div>

      <!-- Card Number Query -->
      <div id="content-query" class="tab-content" style="display: none">
        <div class="card">
          <h2
            style="
              font-size: 1.25rem;
              font-weight: 700;
              margin-bottom: 1rem;
              color: #111827;
            "
          >
            å¡å·æŸ¥è¯¢
          </h2>
          <div class="alert alert-info" style="font-size: 0.875rem">
            <strong>ğŸ’¡ è¯´æ˜ï¼š</strong>
            <ul style="margin-top: 0.5rem; padding-left: 1.25rem">
              <li>é€šè¿‡å¡å·æŸ¥è¯¢äº¤æ˜“æ˜ç»†</li>
              <li>æŸ¥çœ‹ä½™é¢å’Œæ¶ˆè´¹è®°å½•</li>
              <li>é€‚ç”¨äºå·²æ¿€æ´»çš„å¡ç‰‡</li>
            </ul>
          </div>
          <label
            style="
              display: block;
              font-weight: 600;
              color: #374151;
              margin-bottom: 0.5rem;
              font-size: 0.875rem;
            "
          >
            å¡å·
          </label>
          <input
            type="text"
            id="cardNumber"
            class="input-field"
            placeholder="è¯·è¾“å…¥å¡å· (ä¾‹å¦‚: 5123456789012345)"
            style="margin-bottom: 1rem"
          />
          <button class="btn btn-purple" onclick="queryByCardNumber()">
            ğŸ” æŸ¥è¯¢äº¤æ˜“æ˜ç»†
          </button>
        </div>

        <!-- Query Result -->
        <div id="queryResult"></div>
      </div>

      <!-- Card List -->
      <div id="content-cards" class="tab-content" style="display: none">
        <div class="card">
          <h2
            style="
              font-size: 1.25rem;
              font-weight: 700;
              margin-bottom: 1rem;
              color: #111827;
            "
          >
            å¡ç‰‡åˆ—è¡¨
          </h2>

          <!-- Filters -->
          <div style="margin-bottom: 1rem">
            <label
              style="
                display: block;
                font-weight: 600;
                color: #374151;
                margin-bottom: 0.5rem;
                font-size: 0.875rem;
              "
            >
              æœç´¢
            </label>
            <input
              type="text"
              id="cardSearch"
              class="input-field"
              placeholder="æœç´¢å¡å¯†æˆ–å¡å·"
              style="margin-bottom: 0.75rem"
              oninput="loadCardList()"
            />

            <label
              style="
                display: block;
                font-weight: 600;
                color: #374151;
                margin-bottom: 0.5rem;
                font-size: 0.875rem;
              "
            >
              çŠ¶æ€ç­›é€‰
            </label>
            <select
              id="cardStatusFilter"
              class="input-field"
              style="margin-bottom: 0.75rem"
              onchange="loadCardList()"
            >
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="active">å·²æ¿€æ´»</option>
              <option value="inactive">æœªæ¿€æ´»</option>
              <option value="expired">å·²è¿‡æœŸ</option>
            </select>

            <label
              style="
                display: block;
                font-weight: 600;
                color: #374151;
                margin-bottom: 0.5rem;
                font-size: 0.875rem;
              "
            >
              å”®å–çŠ¶æ€
            </label>
            <select
              id="cardSoldFilter"
              class="input-field"
              style="margin-bottom: 0.75rem"
              onchange="loadCardList()"
            >
              <option value="">å…¨éƒ¨</option>
              <option value="sold">å·²å”®å–</option>
              <option value="unsold">æœªå”®å–</option>
            </select>

            <label
              style="
                display: block;
                font-weight: 600;
                color: #374151;
                margin-bottom: 0.5rem;
                font-size: 0.875rem;
              "
            >
              é¢åº¦ç­›é€‰
            </label>
            <input
              type="number"
              id="limitFilter"
              class="input-field"
              placeholder="ç­›é€‰é¢åº¦ (å¦‚: 1, 2, 5)"
              step="0.01"
              min="0"
              style="margin-bottom: 0.75rem"
              oninput="loadCardList()"
            />
          </div>

          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 0.75rem;
            "
          >
            <span style="font-size: 0.875rem; color: #6b7280">
              å…±
              <span id="cardCount" style="font-weight: 600; color: #111827"
                >0</span
              >
              å¼ å¡ç‰‡
            </span>
            <button
              onclick="loadCardList()"
              style="
                padding: 0.5rem 1rem;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 0.5rem;
                font-weight: 600;
                font-size: 0.75rem;
              "
            >
              ğŸ”„ åˆ·æ–°
            </button>
          </div>

          <!-- æ‰¹é‡æ“ä½œæ  -->
          <div
            style="
              display: flex;
              gap: 0.5rem;
              align-items: center;
              margin-bottom: 1rem;
              padding: 0.75rem;
              background: #f9fafb;
              border-radius: 0.5rem;
            "
          >
            <label
              style="
                display: flex;
                align-items: center;
                gap: 0.5rem;
                cursor: pointer;
                flex: 1;
              "
            >
              <input
                type="checkbox"
                id="selectAllCards"
                onchange="toggleSelectAll()"
                style="width: 1.25rem; height: 1.25rem; cursor: pointer"
              />
              <span
                style="font-size: 0.875rem; font-weight: 600; color: #374151"
              >
                å…¨é€‰ (<span id="selectedCount">0</span>)
              </span>
            </label>
            <button
              id="batchCopyBtn"
              onclick="batchCopyCardIds()"
              disabled
              style="
                padding: 0.5rem 1rem;
                background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                color: white;
                border: none;
                border-radius: 0.5rem;
                font-weight: 600;
                font-size: 0.75rem;
                opacity: 0.5;
                cursor: not-allowed;
              "
            >
              ğŸ“‹ å¤åˆ¶å¡å¯†
            </button>
            <button
              id="batchMarkSoldBtn"
              onclick="batchMarkAsSold()"
              disabled
              style="
                padding: 0.5rem 1rem;
                background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
                color: white;
                border: none;
                border-radius: 0.5rem;
                font-weight: 600;
                font-size: 0.75rem;
                opacity: 0.5;
                cursor: not-allowed;
              "
            >
              âœ… æ ‡è®°å”®å–
            </button>
          </div>
        </div>

        <!-- Card List Container -->
        <div id="cardListContainer"></div>
      </div>

      <!-- Footer -->
    </div>

    <script>
      // ==================== Authentication ====================
      const AuthManager = {
        getToken() {
          return localStorage.getItem("access_token");
        },
        setToken(token) {
          localStorage.setItem("access_token", token);
        },
        clearToken() {
          localStorage.removeItem("access_token");
        },
        isAuthenticated() {
          return !!this.getToken();
        },
        setGuestMode(enabled) {
          localStorage.setItem("guest_mode", enabled ? "true" : "false");
        },
        isGuestMode() {
          return localStorage.getItem("guest_mode") === "true";
        },
        clearGuestMode() {
          localStorage.removeItem("guest_mode");
        },
      };

      // ==================== Login & Logout ====================
      async function handleLogin(event) {
        event.preventDefault();

        const username = document.getElementById("loginUsername").value.trim();
        const password = document.getElementById("loginPassword").value.trim();
        const errorDiv = document.getElementById("loginError");

        if (!username || !password) {
          errorDiv.textContent = "è¯·è¾“å…¥è´¦å·å’Œå¯†ç ";
          errorDiv.style.display = "block";
          return;
        }

        showLoading();
        errorDiv.style.display = "none";

        try {
          const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username, password }),
          });

          const data = await response.json();

          if (response.ok && data.success) {
            AuthManager.setToken(data.access_token);
            AuthManager.clearGuestMode();
            showMainApp(username);
            showToast("ç™»å½•æˆåŠŸï¼", "success");
          } else {
            errorDiv.textContent = data.detail || data.message || "ç™»å½•å¤±è´¥";
            errorDiv.style.display = "block";
          }
        } catch (error) {
          errorDiv.textContent = "ç½‘ç»œé”™è¯¯: " + error.message;
          errorDiv.style.display = "block";
        } finally {
          hideLoading();
        }
      }

      function enterGuestMode() {
        AuthManager.setGuestMode(true);
        showMainApp(null);
        showToast("å·²è¿›å…¥è®¿å®¢æ¨¡å¼", "info");
      }

      function handleLogout() {
        if (confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")) {
          AuthManager.clearToken();
          AuthManager.clearGuestMode();
          document.getElementById("loginPage").style.display = "block";
          document.getElementById("mainApp").style.display = "none";
          document.getElementById("loginUsername").value = "";
          document.getElementById("loginPassword").value = "";
          showToast("å·²é€€å‡ºç™»å½•", "info");
        }
      }

      function showMainApp(username) {
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("mainApp").style.display = "block";

        const isGuest = AuthManager.isGuestMode();
        const userInfo = document.getElementById("userInfo");
        const logoutBtn = document.getElementById("logoutBtn");
        const cardsTab = document.getElementById("tab-cards");

        if (isGuest) {
          userInfo.textContent = "è®¿å®¢æ¨¡å¼ - ä»…æŸ¥è¯¢æ¿€æ´»";
          logoutBtn.style.display = "block";
          cardsTab.style.display = "none";
        } else {
          userInfo.textContent = `æ¬¢è¿, ${username || "ç®¡ç†å‘˜"}`;
          logoutBtn.style.display = "block";
          cardsTab.style.display = "block";
        }
      }

      // ==================== Tab Switching ====================
      function switchTab(tab) {
        // Update tab buttons
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document.getElementById("tab-" + tab).classList.add("active");

        // Update content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.style.display = "none";
        });
        document.getElementById("content-" + tab).style.display = "block";

        // Load data for specific tabs
        if (tab === "cards") {
          loadCardList();
        }
      }

      // ==================== Loading ====================
      function showLoading() {
        document.getElementById("loading").classList.add("active");
      }

      function hideLoading() {
        document.getElementById("loading").classList.remove("active");
      }

      // ==================== Toast ====================
      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        const bgColor =
          type === "success"
            ? "#10b981"
            : type === "error"
            ? "#ef4444"
            : "#3b82f6";
        toast.style.cssText = `
                position: fixed;
                top: 1rem;
                left: 1rem;
                right: 1rem;
                background: ${bgColor};
                color: white;
                padding: 1rem;
                border-radius: 0.75rem;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                animation: fadeIn 0.3s ease-in;
            `;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translateY(-20px)";
          toast.style.transition = "all 0.3s ease";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // ==================== Card ID Tooltip ====================
      let tooltipTimeout;
      let currentTooltip = null;

      function showCardIdTooltip(event, cardId) {
        event.preventDefault();

        // é•¿æŒ‰500msåæ˜¾ç¤ºæç¤º
        tooltipTimeout = setTimeout(() => {
          // ç§»é™¤å·²å­˜åœ¨çš„æç¤º
          if (currentTooltip) {
            currentTooltip.remove();
          }

          // åˆ›å»ºæ–°æç¤º
          const tooltip = document.createElement("div");
          tooltip.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.875rem;
            z-index: 10001;
            max-width: 90%;
            word-break: break-all;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.2s ease-in;
          `;
          tooltip.textContent = cardId;
          document.body.appendChild(tooltip);
          currentTooltip = tooltip;

          // 3ç§’åè‡ªåŠ¨éšè—
          setTimeout(() => {
            if (currentTooltip === tooltip) {
              hideCardIdTooltip();
            }
          }, 3000);
        }, 500);
      }

      function hideCardIdTooltip() {
        // æ¸…é™¤å®šæ—¶å™¨
        if (tooltipTimeout) {
          clearTimeout(tooltipTimeout);
          tooltipTimeout = null;
        }

        // ç§»é™¤æç¤º
        if (currentTooltip) {
          currentTooltip.style.opacity = "0";
          currentTooltip.style.transition = "opacity 0.2s ease";
          setTimeout(() => {
            if (currentTooltip) {
              currentTooltip.remove();
              currentTooltip = null;
            }
          }, 200);
        }
      }

      // ==================== Single Card Activation ====================
      async function activateSingleCard() {
        const cardId = document.getElementById("singleCardId").value.trim();

        if (!cardId) {
          showToast("è¯·è¾“å…¥å¡å¯†", "error");
          return;
        }

        showLoading();
        try {
          const response = await fetch(`/api/cards/${cardId}/activate`, {
            method: "POST",
          });
          const data = await response.json();

          if (response.ok && data.success) {
            displaySingleResult(data.card_data);
            showToast("æ¿€æ´»æˆåŠŸï¼", "success");
          } else {
            displayError(
              data.detail || data.message || "æ¿€æ´»å¤±è´¥",
              "singleResult"
            );
            showToast(data.detail || "æ¿€æ´»å¤±è´¥", "error");
          }
        } catch (error) {
          displayError("ç½‘ç»œé”™è¯¯: " + error.message, "singleResult");
          showToast("ç½‘ç»œé”™è¯¯", "error");
        } finally {
          hideLoading();
        }
      }

      function displaySingleResult(card) {
        const resultDiv = document.getElementById("singleResult");
        resultDiv.innerHTML = `
                <div class="card fade-in">
                    <h3 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 1rem; color: #111827;">
                        âœ… å¡ç‰‡ä¿¡æ¯
                    </h3>
                    <div class="result-card">
                        <div class="info-row">
                            <span class="info-label">å¡å¯†</span>
                            <span class="info-value">${card.card_id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å¡å·</span>
                            <span class="info-value">${
                              card.card_number || "æœªæ¿€æ´»"
                            }</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">CVC</span>
                            <span class="info-value">${
                              card.card_cvc || "æœªæ¿€æ´»"
                            }</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æœ‰æ•ˆæœŸ</span>
                            <span class="info-value">${
                              card.card_exp_date || "æœªæ¿€æ´»"
                            }</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">é¢åº¦</span>
                            <span class="info-value">$${card.card_limit}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">çŠ¶æ€</span>
                            <span class="info-value">${getStatusBadge(
                              card.status
                            )}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å”®å–çŠ¶æ€</span>
                            <span class="info-value">${getSoldBadge(
                              card.is_sold || false
                            )}</span>
                        </div>
                        ${
                          card.exp_date
                            ? `
                        <div class="info-row">
                            <span class="info-label">è¿‡æœŸæ—¶é—´</span>
                            <span class="info-value">${formatDate(
                              card.exp_date
                            )}</span>
                        </div>
                        `
                            : ""
                        }
                        ${
                          card.billing_address
                            ? `
                        <div class="info-row" style="border-bottom: none; padding-bottom: 0;">
                            <span class="info-label">è´¦å•åœ°å€</span>
                        </div>
                        <div style="padding: 0.75rem 0 0.75rem 0;">
                            <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 0.5rem; padding: 0.75rem; position: relative;">
                                <p style="color: #166534; font-size: 0.875rem; font-family: 'Courier New', monospace; word-break: break-all; margin: 0;" id="billing-addr-${card.card_id}">
                                    ${card.billing_address}
                                </p>
                            </div>
                        </div>
                        `
                            : ""
                        }
                    </div>
                    ${
                      card.card_number
                        ? `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="copyCardInfo('${card.card_id}')" style="margin: 0; padding: 0.75rem; font-size: 0.875rem;">
                            ğŸ“‹ å¤åˆ¶å®Œæ•´ä¿¡æ¯
                        </button>
                        <button class="btn btn-purple" onclick="viewTransactions('${card.card_id}')" style="margin: 0; padding: 0.75rem; font-size: 0.875rem;">
                            ğŸ“Š æŸ¥çœ‹è®°å½•
                        </button>
                    </div>
                    `
                        : ""
                    }
                    <div id="transactions-${card.card_id}"></div>
                </div>
            `;
      }

      // ==================== Batch Activation ====================
      async function activateBatchCards() {
        const textarea = document.getElementById("batchCardIds");
        const content = textarea.value.trim();

        if (!content) {
          showToast("è¯·è¾“å…¥å¡å¯†", "error");
          return;
        }

        const cardIds = content
          .split("\n")
          .map((line) => line.trim())
          .filter((line) => line.length > 0);

        if (cardIds.length === 0) {
          showToast("æœªæ‰¾åˆ°æœ‰æ•ˆçš„å¡å¯†", "error");
          return;
        }

        const concurrency = 5;
        const maxRetries = 3;

        showLoading();
        const resultDiv = document.getElementById("batchResult");
        resultDiv.innerHTML = `
                <div class="card fade-in">
                    <h3 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 1rem; color: #111827;">
                        âš¡ æ‰¹é‡æ¿€æ´»è¿›åº¦
                    </h3>
                    <div style="background: #f3f4f6; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem;">
                            <span style="color: #6b7280;">æ€»æ•°: ${cardIds.length}</span>
                            <span style="color: #10b981; font-weight: 600;">æˆåŠŸ: <span id="batchSuccess">0</span></span>
                            <span style="color: #ef4444; font-weight: 600;">å¤±è´¥: <span id="batchFailed">0</span></span>
                        </div>
                        <div style="width: 100%; height: 0.5rem; background: #e5e7eb; border-radius: 9999px; overflow: hidden;">
                            <div id="batchProgress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #10b981, #059669); transition: width 0.3s;"></div>
                        </div>
                    </div>
                    <div id="batchLog" style="max-height: 300px; overflow-y: auto; font-size: 0.75rem; font-family: 'Courier New', monospace; background: #f9fafb; border-radius: 0.5rem; padding: 0.75rem;"></div>
                </div>
            `;

        try {
          const response = await fetch("/api/cards/batch/activate", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              card_ids: cardIds,
              concurrency: concurrency,
              max_retries: maxRetries,
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || "æ‰¹é‡æ¿€æ´»è¯·æ±‚å¤±è´¥");
          }

          // Update stats
          document.getElementById("batchSuccess").textContent =
            data.data.success_count;
          document.getElementById("batchFailed").textContent =
            data.data.failed_count;
          document.getElementById("batchProgress").style.width = "100%";

          // Display logs
          const logDiv = document.getElementById("batchLog");
          let logHtml = `<div style="color: #10b981; font-weight: 600; margin-bottom: 0.5rem;">âœ… æ‰¹é‡æ¿€æ´»å®Œæˆï¼</div>`;
          logHtml += `<div style="margin-bottom: 0.75rem; color: #6b7280;">æ€»æ•°: ${data.data.total} | æˆåŠŸ: ${data.data.success_count} | å¤±è´¥: ${data.data.failed_count}</div>`;

          if (data.data.success && data.data.success.length > 0) {
            logHtml += `<div style="color: #10b981; font-weight: 600; margin-top: 0.75rem; margin-bottom: 0.5rem;">æˆåŠŸæ¿€æ´»:</div>`;
            data.data.success.forEach((item) => {
              const retryText =
                item.retry_count > 0 ? ` (é‡è¯•${item.retry_count}æ¬¡)` : "";
              const addressText = item.billing_address
                ? ` [è´¦å•åœ°å€: ${item.billing_address}]`
                : "";
              logHtml += `<div style="color: #059669; margin-bottom: 0.25rem;">âœ“ ${item.card_id}${addressText}${retryText}</div>`;
            });
          }

          if (data.data.failed && data.data.failed.length > 0) {
            logHtml += `<div style="color: #ef4444; font-weight: 600; margin-top: 0.75rem; margin-bottom: 0.5rem;">å¤±è´¥:</div>`;
            data.data.failed.forEach((item) => {
              const retryText =
                item.retry_count > 0 ? ` (å·²é‡è¯•${item.retry_count}æ¬¡)` : "";
              logHtml += `<div style="color: #dc2626; margin-bottom: 0.25rem;">âœ— ${item.card_id}: ${item.message}${retryText}</div>`;
            });
          }

          logDiv.innerHTML = logHtml;

          showToast(
            `æ‰¹é‡æ¿€æ´»å®Œæˆï¼æˆåŠŸ: ${data.data.success_count}, å¤±è´¥: ${data.data.failed_count}`,
            data.data.failed_count === 0 ? "success" : "info"
          );

          if (data.data.failed_count === 0) {
            textarea.value = "";
          }
        } catch (error) {
          const logDiv = document.getElementById("batchLog");
          logDiv.innerHTML = `<div style="color: #ef4444; font-weight: 600;">âŒ æ‰¹é‡æ¿€æ´»å¤±è´¥: ${error.message}</div>`;
          showToast("æ‰¹é‡æ¿€æ´»å¤±è´¥: " + error.message, "error");
        } finally {
          hideLoading();
        }
      }

      // ==================== Card Number Query ====================
      async function queryByCardNumber() {
        const cardNumber = document.getElementById("cardNumber").value.trim();

        if (!cardNumber) {
          showToast("è¯·è¾“å…¥å¡å·", "error");
          return;
        }

        showLoading();
        const resultDiv = document.getElementById("queryResult");

        try {
          const response = await fetch(
            `/api/cards/query-by-card-number/${cardNumber}`,
            {
              method: "POST",
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || "æŸ¥è¯¢å¤±è´¥");
          }

          const data = await response.json();
          const cardInfo = data.data;

          let html = `
                    <div class="card fade-in">
                        <h3 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 1rem; color: #111827;">
                            ğŸ“Š äº¤æ˜“æ˜ç»†
                        </h3>
                        <div class="result-card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #3b82f6;">
                            <div class="info-row">
                                <span class="info-label">å¡å·</span>
                                <span class="info-value">${
                                  cardInfo.card_number || cardNumber
                                }</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">çŠ¶æ€</span>
                                <span class="info-value">${getStatusBadge(
                                  cardInfo.status || "N/A"
                                )}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ä½™é¢</span>
                                <span class="info-value" style="color: #10b981; font-size: 1.125rem;">$${
                                  cardInfo.available !== undefined
                                    ? cardInfo.available.toFixed(2)
                                    : "N/A"
                                }</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å·²ç”¨</span>
                                <span class="info-value" style="color: #3b82f6; font-size: 1.125rem;">$${
                                  cardInfo.pending !== undefined
                                    ? cardInfo.pending.toFixed(2)
                                    : "N/A"
                                }</span>
                            </div>
                        </div>
                `;

          if (cardInfo.transactions && cardInfo.transactions.length > 0) {
            html += `
                        <h4 style="font-size: 1rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #111827;">
                            ğŸ’³ äº¤æ˜“è®°å½• (${cardInfo.transactions.length} ç¬”)
                        </h4>
                    `;

            cardInfo.transactions.forEach((tx, index) => {
              const isNegative = tx.amount < 0;
              html += `
                            <div class="transaction-item">
                                <div class="transaction-header">
                                    <span class="transaction-merchant">#${
                                      index + 1
                                    } ${
                tx.merchant || tx.bank_description || "æœªçŸ¥å•†æˆ·"
              }</span>
                                    <span class="transaction-amount ${
                                      isNegative ? "negative" : "positive"
                                    }">
                                        ${tx.amount}
                                    </span>
                                </div>
                                <div class="transaction-details">
                                    ${
                                      tx.date
                                        ? `<div>æ—¶é—´: ${formatDate(
                                            tx.date
                                          )}</div>`
                                        : ""
                                    }
                                    ${
                                      tx.status
                                        ? `<div>çŠ¶æ€: ${tx.status}</div>`
                                        : ""
                                    }
                                    ${
                                      tx.reason_for_failure
                                        ? `<div style="color: #ef4444;">å¤±è´¥åŸå› : ${tx.reason_for_failure}</div>`
                                        : ""
                                    }
                                </div>
                            </div>
                        `;
            });
          } else {
            html += `
                        <div style="text-align: center; padding: 2rem; color: #6b7280;">
                            <svg style="width: 3rem; height: 3rem; margin: 0 auto 0.5rem; opacity: 0.5;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p style="font-weight: 600;">æš‚æ— äº¤æ˜“è®°å½•</p>
                        </div>
                    `;
          }

          html += `</div>`;
          resultDiv.innerHTML = html;
          showToast("æŸ¥è¯¢æˆåŠŸ", "success");
        } catch (error) {
          displayError("æŸ¥è¯¢å¤±è´¥: " + error.message, "queryResult");
          showToast("æŸ¥è¯¢å¤±è´¥: " + error.message, "error");
        } finally {
          hideLoading();
        }
      }

      // ==================== View Transactions ====================
      async function viewTransactions(cardId) {
        const transDiv = document.getElementById(`transactions-${cardId}`);
        transDiv.innerHTML = `
                <div style="text-align: center; padding: 1rem; color: #6b7280;">
                    <div class="spinner" style="margin: 0 auto 0.5rem;"></div>
                    <p style="font-size: 0.875rem;">åŠ è½½ä¸­...</p>
                </div>
            `;

        try {
          const response = await fetch(
            `/api/cards/${cardId}/transactions/query`,
            {
              method: "POST",
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || "æŸ¥è¯¢å¤±è´¥");
          }

          const data = await response.json();
          const cardInfo = data.data;

          let html = `
                    <div style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 0.75rem;">
                        <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 0.75rem; color: #111827;">
                            ğŸ“Š ä½¿ç”¨è®°å½•
                        </h4>
                        <div class="result-card" style="background: white;">
                            <div class="info-row">
                                <span class="info-label">ä½™é¢</span>
                                <span class="info-value" style="color: #10b981;">$${
                                  cardInfo.available !== undefined
                                    ? cardInfo.available.toFixed(2)
                                    : "N/A"
                                }</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å·²ç”¨</span>
                                <span class="info-value" style="color: #3b82f6;">$${
                                  cardInfo.pending !== undefined
                                    ? cardInfo.pending.toFixed(2)
                                    : "N/A"
                                }</span>
                            </div>
                        </div>
                `;

          if (cardInfo.transactions && cardInfo.transactions.length > 0) {
            html += `<h5 style="font-size: 0.875rem; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem; color: #111827;">äº¤æ˜“æ˜ç»† (${cardInfo.transactions.length} ç¬”):</h5>`;

            cardInfo.transactions.forEach((tx, index) => {
              const isNegative = tx.amount < 0;
              html += `
                            <div class="transaction-item" style="font-size: 0.75rem;">
                                <div class="transaction-header">
                                    <span class="transaction-merchant">#${
                                      index + 1
                                    } ${
                tx.merchant || tx.bank_description || "æœªçŸ¥"
              }</span>
                                    <span class="transaction-amount ${
                                      isNegative ? "negative" : "positive"
                                    }" style="font-size: 0.875rem;">
                                        ${tx.amount}
                                    </span>
                                </div>
                                ${
                                  tx.date
                                    ? `<div style="color: #6b7280; font-size: 0.7rem;">æ—¶é—´: ${formatDate(
                                        tx.date
                                      )}</div>`
                                    : ""
                                }
                                ${
                                  tx.status
                                    ? `<div style="color: #6b7280; font-size: 0.7rem;">çŠ¶æ€: ${tx.status}</div>`
                                    : ""
                                }
                            </div>
                        `;
            });
          } else {
            html += `<p style="text-align: center; color: #6b7280; padding: 1rem; font-size: 0.875rem;">æš‚æ— äº¤æ˜“è®°å½•</p>`;
          }

          html += `</div>`;
          transDiv.innerHTML = html;
        } catch (error) {
          transDiv.innerHTML = `
                    <div class="alert alert-error" style="margin-top: 1rem; font-size: 0.875rem;">
                        æŸ¥è¯¢å¤±è´¥: ${error.message}
                    </div>
                `;
        }
      }

      // ==================== Helper Functions ====================
      function displayError(message, targetId) {
        const target = document.getElementById(targetId);
        target.innerHTML = `
                <div class="card fade-in">
                    <div class="alert alert-error">
                        <strong>âŒ é”™è¯¯</strong><br>
                        ${message}
                    </div>
                </div>
            `;
      }

      function getStatusBadge(status) {
        const badges = {
          active: '<span class="badge badge-success">å·²æ¿€æ´»</span>',
          inactive: '<span class="badge badge-error">æœªæ¿€æ´»</span>',
          expired: '<span class="badge badge-warning">å·²è¿‡æœŸ</span>',
          deleted:
            '<span class="badge" style="background: #e5e7eb; color: #374151;">å·²åˆ é™¤</span>',
        };
        return badges[status] || `<span class="badge">${status}</span>`;
      }

      // è·å–å”®å–çŠ¶æ€å¾½ç« 
      function getSoldBadge(isSold) {
        if (isSold) {
          return '<span class="badge" style="background: #fef3c7; color: #92400e;">å·²å”®å–</span>';
        } else {
          return '<span class="badge" style="background: #d1fae5; color: #065f46;">æœªå”®å–</span>';
        }
      }

      // ç”Ÿæˆéšæœºç¾å›½äººå
      function generateRandomName() {
        const firstNames = [
          "James",
          "John",
          "Robert",
          "Michael",
          "William",
          "David",
          "Richard",
          "Joseph",
          "Mary",
          "Patricia",
          "Jennifer",
          "Linda",
          "Elizabeth",
          "Barbara",
          "Susan",
          "Jessica",
          "Thomas",
          "Charles",
          "Christopher",
          "Daniel",
          "Matthew",
          "Anthony",
          "Mark",
          "Donald",
          "Nancy",
          "Karen",
          "Lisa",
          "Betty",
          "Margaret",
          "Sandra",
          "Ashley",
          "Kimberly",
        ];
        const lastNames = [
          "Smith",
          "Johnson",
          "Williams",
          "Brown",
          "Jones",
          "Garcia",
          "Miller",
          "Davis",
          "Rodriguez",
          "Martinez",
          "Hernandez",
          "Lopez",
          "Gonzalez",
          "Wilson",
          "Anderson",
          "Thomas",
          "Taylor",
          "Moore",
          "Jackson",
          "Martin",
          "Lee",
          "White",
          "Harris",
          "Thompson",
        ];

        const firstName =
          firstNames[Math.floor(Math.random() * firstNames.length)];
        const lastName =
          lastNames[Math.floor(Math.random() * lastNames.length)];
        return `${firstName} ${lastName}`;
      }

      function formatDate(dateStr) {
        if (!dateStr) return "-";
        const date = new Date(dateStr);
        return date.toLocaleString("zh-CN", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function copyText(elementId) {
        const element = document.getElementById(elementId);
        if (!element) {
          showToast("å¤åˆ¶å¤±è´¥: å…ƒç´ ä¸å­˜åœ¨", "error");
          return;
        }

        const text = element.textContent.trim();

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(text)
            .then(() => {
              showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "success");
            })
            .catch(() => {
              fallbackCopy(text);
            });
        } else {
          fallbackCopy(text);
        }
      }

      function fallbackCopy(text) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.style.position = "fixed";
        textarea.style.opacity = "0";
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand("copy");
          showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "success");
        } catch (err) {
          showToast("å¤åˆ¶å¤±è´¥", "error");
        }
        document.body.removeChild(textarea);
      }

      // å¤åˆ¶å®Œæ•´å¡ç‰‡ä¿¡æ¯
      async function copyCardInfo(cardId) {
        try {
          showLoading();
          // è·å–å¡ç‰‡è¯¦ç»†ä¿¡æ¯ï¼ˆä½¿ç”¨å…¬å¼€æ¥å£,ä¸éœ€è¦é‰´æƒï¼‰
          const response = await fetch(`/api/cards/public/${cardId}`);
          const card = await response.json();

          if (!response.ok) {
            showToast("è·å–å¡ç‰‡ä¿¡æ¯å¤±è´¥", "error");
            return;
          }

          // æ£€æŸ¥å¡ç‰‡æ˜¯å¦å·²æ¿€æ´»
          if (!card.is_activated || !card.card_number) {
            showToast("å¡ç‰‡å°šæœªæ¿€æ´»ï¼Œæ— æ³•å¤åˆ¶ä¿¡æ¯", "error");
            return;
          }

          // è§£æåœ°å€ä¿¡æ¯
          const addr =
            (typeof card.legal_address === "string"
              ? JSON.parse(card.legal_address)
              : card.legal_address) || {};

          // æ ¼å¼åŒ–å¡ç‰‡ä¿¡æ¯
          const cardInfo = `å¡å·: ${card.card_number}
æœ‰æ•ˆæœŸ: ${card.card_exp_date || "æœªçŸ¥"}
å®‰å…¨ç /CVC: ${card.card_cvc || "æœªçŸ¥"}
å§“å: ${generateRandomName()}
å›½å®¶: ${addr.country || "US"}
åœ°å€ç¬¬ä¸€è¡Œ: ${addr.address1 || card.billing_address || "41 Glenn Rd C23"}
åŸå¸‚: ${addr.city || "East Hartford"}
å·: ${addr.region || "CT"}
é‚®ç¼–: ${addr.postal_code || "06118"}`;

          // å¤åˆ¶åˆ°å‰ªè´´æ¿
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(cardInfo);
            showToast("å¡ç‰‡ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "success");
          } else {
            fallbackCopy(cardInfo);
          }
        } catch (error) {
          console.log(error, "===error");
          showToast("å¤åˆ¶å¤±è´¥: " + error.message, "error");
        } finally {
          hideLoading();
        }
      }

      // ==================== Activate Card From List ====================
      async function activateCardFromList(cardId) {
        const resultDiv = document.getElementById(
          `activation-result-${cardId}`
        );

        try {
          showLoading();

          const response = await fetch(`/api/cards/${cardId}/activate`, {
            method: "POST",
          });
          const data = await response.json();

          if (response.ok && data.success) {
            const card = data.card_data;

            // æ˜¾ç¤ºæ¿€æ´»æˆåŠŸçš„ä¿¡æ¯
            resultDiv.innerHTML = `
              <div style="margin-top: 0.75rem; padding: 0.75rem; background: #d1fae5; border: 1px solid #10b981; border-radius: 0.5rem;">
                <div style="color: #065f46; font-weight: 600; font-size: 0.75rem; margin-bottom: 0.5rem;">
                  âœ… æ¿€æ´»æˆåŠŸï¼
                </div>
                <div style="font-size: 0.7rem; color: #059669;">
                  <div>å¡å·: ${card.card_number || "N/A"}</div>
                  <div>CVC: ${card.card_cvc || "N/A"}</div>
                  <div>æœ‰æ•ˆæœŸ: ${card.card_exp_date || "N/A"}</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                  <button onclick="copyCardInfo('${cardId}')" style="padding: 0.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; font-size: 0.7rem;">
                    ğŸ“‹ å¤åˆ¶ä¿¡æ¯
                  </button>
                  <button onclick="viewTransactions('${cardId}')" style="padding: 0.5rem; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; font-size: 0.7rem;">
                    ğŸ“Š æŸ¥çœ‹è®°å½•
                  </button>
                </div>
                <div id="transactions-${cardId}"></div>
              </div>
            `;

            showToast("æ¿€æ´»æˆåŠŸï¼", "success");

            // 3ç§’ååˆ·æ–°åˆ—è¡¨
            setTimeout(() => {
              loadCardList();
            }, 3000);
          } else {
            resultDiv.innerHTML = `
              <div style="margin-top: 0.75rem; padding: 0.75rem; background: #fee2e2; border: 1px solid #ef4444; border-radius: 0.5rem;">
                <div style="color: #991b1b; font-weight: 600; font-size: 0.75rem;">
                  âŒ æ¿€æ´»å¤±è´¥
                </div>
                <div style="color: #dc2626; font-size: 0.7rem; margin-top: 0.25rem;">
                  ${data.detail || data.message || "æœªçŸ¥é”™è¯¯"}
                </div>
              </div>
            `;
            showToast(data.detail || "æ¿€æ´»å¤±è´¥", "error");
          }
        } catch (error) {
          resultDiv.innerHTML = `
            <div style="margin-top: 0.75rem; padding: 0.75rem; background: #fee2e2; border: 1px solid #ef4444; border-radius: 0.5rem;">
              <div style="color: #991b1b; font-weight: 600; font-size: 0.75rem;">
                âŒ ç½‘ç»œé”™è¯¯
              </div>
              <div style="color: #dc2626; font-size: 0.7rem; margin-top: 0.25rem;">
                ${error.message}
              </div>
            </div>
          `;
          showToast("ç½‘ç»œé”™è¯¯", "error");
        } finally {
          hideLoading();
        }
      }

      // ==================== Card List ====================
      async function loadCardList() {
        if (!AuthManager.isAuthenticated() || AuthManager.isGuestMode()) {
          showToast("è¯·å…ˆç™»å½•ä»¥æŸ¥çœ‹å¡ç‰‡åˆ—è¡¨", "error");
          return;
        }

        const search = document.getElementById("cardSearch")?.value || "";
        const status = document.getElementById("cardStatusFilter")?.value || "";
        const soldFilter =
          document.getElementById("cardSoldFilter")?.value || "";
        const limitFilter = document.getElementById("limitFilter")?.value || "";
        const container = document.getElementById("cardListContainer");

        showLoading();

        try {
          // æ„å»ºæŸ¥è¯¢å‚æ•° - æ‰€æœ‰ç­›é€‰ç”±åç«¯å®Œæˆ
          const params = new URLSearchParams();
          params.append("limit", "100");

          // æœç´¢å‚æ•°
          if (search) params.append("search", search);

          // çŠ¶æ€ç­›é€‰
          if (status) {
            params.append("status", status);
          } else {
            // å¦‚æœæ²¡æœ‰é€‰æ‹©çŠ¶æ€ç­›é€‰,é»˜è®¤æ’é™¤å·²åˆ é™¤çš„å¡ç‰‡
            params.append("exclude_deleted", "true");
          }

          // å”®å–çŠ¶æ€ç­›é€‰
          if (soldFilter === "sold") {
            params.append("is_sold", "true");
          } else if (soldFilter === "unsold") {
            params.append("is_sold", "false");
          }

          // é¢åº¦ç­›é€‰
          if (limitFilter) {
            const limitValue = parseFloat(limitFilter);
            if (!isNaN(limitValue)) {
              params.append("card_limit", limitValue);
            }
          }

          const url = `/api/cards/?${params.toString()}`;
          const response = await fetch(url, {
            headers: {
              Authorization: "Bearer " + AuthManager.getToken(),
            },
          });

          if (!response.ok) {
            if (response.status === 401) {
              showToast("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•", "error");
              handleLogout();
              return;
            }
            throw new Error("åŠ è½½å¤±è´¥");
          }

          let data = await response.json();
          // æ–°çš„APIè¿”å›æ ¼å¼: { items: [], total: 0, skip: 0, limit: 100 }
          let cards = data.items || data; // å…¼å®¹æ–°æ—§æ ¼å¼
          const totalRecords = data.total || cards.length;

          document.getElementById("cardCount").textContent = totalRecords;

          if (cards.length === 0) {
            container.innerHTML = `
              <div class="card">
                <div style="text-align: center; padding: 2rem; color: #6b7280;">
                  <svg style="width: 3rem; height: 3rem; margin: 0 auto 0.5rem; opacity: 0.5;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                  </svg>
                  <p style="font-weight: 600;">æš‚æ— å¡ç‰‡</p>
                </div>
              </div>
            `;
            return;
          }

          let html = "";
          cards.forEach((card) => {
            html += `
              <div class="card fade-in" style="margin-bottom: 0.75rem;">
                <!-- ç¬¬ä¸€è¡Œ: å¤é€‰æ¡† + å¡å¯† -->
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                  <input
                    type="checkbox"
                    class="card-checkbox"
                    data-card-id="${card.card_id}"
                    onchange="updateSelectedCount()"
                    style="width: 1.25rem; height: 1.25rem; margin-top: 0.125rem; cursor: pointer; flex-shrink: 0;"
                  />
                  <div style="flex: 1; min-width: 0;">
                    <div 
                      style="font-weight: 700; color: #111827; font-size: 0.875rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer;"
                      title="${card.card_id}"
                      ontouchstart="showCardIdTooltip(event, '${card.card_id}')"
                      ontouchend="hideCardIdTooltip()"
                    >
                      ${card.card_id}
                    </div>
                  </div>
                </div>
                
                <!-- ç¬¬äºŒè¡Œ: å¡å· + çŠ¶æ€ -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding-left: 2rem;">
                  <div style="font-size: 0.75rem; color: #6b7280; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${card.card_number || "æœªæ¿€æ´»"}
                  </div>
                  <div style="flex-shrink: 0; margin-left: 0.5rem;">
                    ${getStatusBadge(card.status)}
                  </div>
                </div>
                
                <div style="background: #f9fafb; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.75rem;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6b7280;">é¢åº¦:</span>
                    <span style="font-weight: 600; color: #111827;">$${
                      card.card_limit
                    }</span>
                  </div>
                  ${
                    card.card_exp_date
                      ? `
                  <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6b7280;">æœ‰æ•ˆæœŸ:</span>
                    <span style="font-weight: 600; color: #111827;">${card.card_exp_date}</span>
                  </div>
                  `
                      : ""
                  }
                  ${
                    card.exp_date
                      ? `
                  <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: #6b7280;">è¿‡æœŸæ—¶é—´:</span>
                    <span style="font-weight: 600; color: #111827;">${formatDate(
                      card.exp_date
                    )}</span>
                  </div>
                  `
                      : ""
                  }
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: #6b7280;">å”®å–çŠ¶æ€:</span>
                    <span>${getSoldBadge(card.is_sold || false)}</span>
                  </div>
                </div>

                ${
                  card.is_activated && card.card_number
                    ? `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.75rem;">
                  <button onclick="copyCardInfo('${card.card_id}')" style="padding: 0.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; font-size: 0.75rem;">
                    ğŸ“‹ å¤åˆ¶ä¿¡æ¯
                  </button>
                  <button onclick="viewTransactions('${card.card_id}')" style="padding: 0.5rem; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; font-size: 0.75rem;">
                    ğŸ“Š æŸ¥çœ‹è®°å½•
                  </button>
                </div>
                <div id="transactions-${card.card_id}"></div>
                `
                    : `
                <div style="margin-top: 0.75rem;">
                  <button onclick="activateCardFromList('${card.card_id}')" style="width: 100%; padding: 0.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; font-size: 0.75rem;">
                    ğŸš€ æ¿€æ´»å¡ç‰‡
                  </button>
                </div>
                <div id="activation-result-${card.card_id}"></div>
                `
                }
              </div>
            `;
          });

          container.innerHTML = html;
        } catch (error) {
          container.innerHTML = `
            <div class="card">
              <div class="alert alert-error">
                åŠ è½½å¤±è´¥: ${error.message}
              </div>
            </div>
          `;
          showToast("åŠ è½½å¡ç‰‡åˆ—è¡¨å¤±è´¥", "error");
        } finally {
          hideLoading();
        }
      }

      // ==================== Batch Selection ====================
      function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById("selectAllCards");
        const cardCheckboxes = document.querySelectorAll(".card-checkbox");

        cardCheckboxes.forEach((checkbox) => {
          checkbox.checked = selectAllCheckbox.checked;
        });

        updateSelectedCount();
      }

      function updateSelectedCount() {
        const cardCheckboxes = document.querySelectorAll(".card-checkbox");
        const selectedCheckboxes = document.querySelectorAll(
          ".card-checkbox:checked"
        );
        const selectedCount = selectedCheckboxes.length;

        // æ›´æ–°é€‰ä¸­è®¡æ•°
        document.getElementById("selectedCount").textContent = selectedCount;

        // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
        const selectAllCheckbox = document.getElementById("selectAllCards");
        if (selectedCount === 0) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        } else if (selectedCount === cardCheckboxes.length) {
          selectAllCheckbox.checked = true;
          selectAllCheckbox.indeterminate = false;
        } else {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = true;
        }

        // æ›´æ–°æ‰¹é‡å¤åˆ¶æŒ‰é’®çŠ¶æ€
        const batchCopyBtn = document.getElementById("batchCopyBtn");
        const batchMarkSoldBtn = document.getElementById("batchMarkSoldBtn");

        if (selectedCount > 0) {
          batchCopyBtn.disabled = false;
          batchCopyBtn.style.opacity = "1";
          batchCopyBtn.style.cursor = "pointer";

          batchMarkSoldBtn.disabled = false;
          batchMarkSoldBtn.style.opacity = "1";
          batchMarkSoldBtn.style.cursor = "pointer";
        } else {
          batchCopyBtn.disabled = true;
          batchCopyBtn.style.opacity = "0.5";
          batchCopyBtn.style.cursor = "not-allowed";

          batchMarkSoldBtn.disabled = true;
          batchMarkSoldBtn.style.opacity = "0.5";
          batchMarkSoldBtn.style.cursor = "not-allowed";
        }
      }

      function batchCopyCardIds() {
        const selectedCheckboxes = document.querySelectorAll(
          ".card-checkbox:checked"
        );

        if (selectedCheckboxes.length === 0) {
          showToast("è¯·å…ˆé€‰æ‹©è¦å¤åˆ¶çš„å¡ç‰‡", "error");
          return;
        }

        // æ”¶é›†æ‰€æœ‰é€‰ä¸­çš„å¡å¯†
        const cardIds = Array.from(selectedCheckboxes).map((checkbox) =>
          checkbox.getAttribute("data-card-id")
        );

        // å°†å¡å¯†ç”¨æ¢è¡Œç¬¦è¿æ¥
        const cardIdsText = cardIds.join("\n");

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(cardIdsText)
            .then(() => {
              showToast(`å·²å¤åˆ¶ ${cardIds.length} ä¸ªå¡å¯†åˆ°å‰ªè´´æ¿`, "success");

              // å–æ¶ˆæ‰€æœ‰é€‰ä¸­
              selectedCheckboxes.forEach((checkbox) => {
                checkbox.checked = false;
              });
              updateSelectedCount();
            })
            .catch(() => {
              fallbackCopy(cardIdsText);
            });
        } else {
          fallbackCopy(cardIdsText);

          // å–æ¶ˆæ‰€æœ‰é€‰ä¸­
          selectedCheckboxes.forEach((checkbox) => {
            checkbox.checked = false;
          });
          updateSelectedCount();
        }
      }

      // ==================== Batch Mark As Sold ====================
      async function batchMarkAsSold() {
        const selectedCheckboxes = document.querySelectorAll(
          ".card-checkbox:checked"
        );

        if (selectedCheckboxes.length === 0) {
          showToast("è¯·å…ˆé€‰æ‹©è¦æ ‡è®°çš„å¡ç‰‡", "error");
          return;
        }

        // æ”¶é›†æ‰€æœ‰é€‰ä¸­çš„å¡å¯†
        const cardIds = Array.from(selectedCheckboxes).map((checkbox) =>
          checkbox.getAttribute("data-card-id")
        );

        // ç¡®è®¤æ“ä½œ
        if (!confirm(`ç¡®å®šè¦å°† ${cardIds.length} å¼ å¡ç‰‡æ ‡è®°ä¸ºå·²å”®å–å—ï¼Ÿ`)) {
          return;
        }

        showLoading();

        let successCount = 0;
        let failCount = 0;

        try {
          // æ‰¹é‡æ ‡è®°å”®å–
          for (const cardId of cardIds) {
            try {
              const response = await fetch(`/api/cards/${cardId}/mark-sold`, {
                method: "POST",
                headers: {
                  Authorization: "Bearer " + AuthManager.getToken(),
                },
              });

              if (response.ok) {
                successCount++;
              } else {
                failCount++;
              }
            } catch (error) {
              failCount++;
            }
          }

          // æ˜¾ç¤ºç»“æœ
          showToast(
            `æˆåŠŸæ ‡è®° ${successCount} å¼ ï¼Œå¤±è´¥ ${failCount} å¼ `,
            successCount > 0 ? "success" : "error"
          );

          // å–æ¶ˆæ‰€æœ‰é€‰ä¸­
          selectedCheckboxes.forEach((checkbox) => {
            checkbox.checked = false;
          });
          updateSelectedCount();

          // åˆ·æ–°åˆ—è¡¨
          if (successCount > 0) {
            setTimeout(() => {
              loadCardList();
            }, 1000);
          }
        } catch (error) {
          showToast("æ‰¹é‡æ ‡è®°å¤±è´¥: " + error.message, "error");
        } finally {
          hideLoading();
        }
      }

      // ==================== Initialize ====================
      document.addEventListener("DOMContentLoaded", function () {
        // Prevent zoom on input focus (iOS)
        document.querySelectorAll("input, textarea").forEach((element) => {
          element.addEventListener("focus", function () {
            this.style.fontSize = "16px";
          });
        });

        // Check login status
        if (AuthManager.isAuthenticated()) {
          showMainApp("ç”¨æˆ·");
        } else if (AuthManager.isGuestMode()) {
          showMainApp(null);
        }
      });
    </script>
  </body>
</html>
